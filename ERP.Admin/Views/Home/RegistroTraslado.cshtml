@{
    ViewBag.Title = "Registro de traslados";
    ViewBag.Description = "traslados";
    Layout = "~/Views/Shared/_Default.cshtml";
    int _numeroLeido = 0;
}

@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "MyForm" }))
{ }
@Html.Hidden("txt_numeroxLeido", _numeroLeido)
<div class="row">
    <div class="col-lg-12 col-sm-12 col-xs-12">
        <div class="widget">
            <div class="widget-header bordered-bottom bordered-red">
                <span class="widget-caption">Nuevo registro de traslado</span>
            </div>
            <div class="widget-body">
                <div id="horizontal-form">
                    @using (var f = Html.Bootstrap().Begin(new Form().Type(FormType.Horizontal)))
                    {
                        <div class="row">
                            <div class="col-md-2">
                                Origen
                                @Html.Bootstrap().DropDownList("origen", new SelectList(ViewBag.Lugares, "id", "lugar"))
                                <div class="horizontal-space"></div>
                            </div>
                            <div class="col-md-2">
                                Zona
                                @Html.Bootstrap().DropDownList("fk_zona_embarque", new List<SelectListItem>())
                                <div class="horizontal-space"></div>
                            </div>
                            <div class="col-md-2">
                                Destino
                                @Html.Bootstrap().DropDownList("destino", new List<SelectListItem>())
                                <div class="horizontal-space"></div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-1 control-label">Placa <sup>*</sup></label>
                                <div class="col-md-1">
                                    @Html.Bootstrap().TextBox("placa").HtmlAttributes(new { @onkeyup = "InputToUpper(this)" }).Placeholder("Placa")
                                    @Html.Hidden("fk_placa", 0)
                                    <div class="horizontal-space"></div>
                                </div>
                                <label class="col-sm-1 control-label">Precinto <sup>*</sup></label>
                                <div class="col-md-1">
                                    @Html.Bootstrap().TextBox("precinto").HtmlAttributes(new { @onkeyup = "InputToUpper(this)" }).Placeholder("Precinto")
                                    <div class="horizontal-space"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label class="col-sm-1 control-label">DNI Conductor <sup>*</sup></label>
                                <div class="col-md-1">
                                    @Html.Bootstrap().TextBox("dni").Placeholder("DNI")
                                    @Html.Hidden("fk_conductor", 0)
                                    <div class="horizontal-space"></div>
                                </div>
                                <label class="col-sm-1 control-label">Brevete <sup>*</sup></label>
                                <div class="col-md-1">
                                    @Html.Bootstrap().TextBox("brevete").HtmlAttributes(new { @onkeyup = "InputToUpper(this)" }).Placeholder("Brevete")
                                    <div class="horizontal-space"></div>
                                </div>
                                <label class="col-sm-1 control-label">Nombres <sup>*</sup></label>
                                <div class="col-md-2">
                                    @Html.Bootstrap().TextBox("nombres").HtmlAttributes(new { @onkeyup = "InputToUpper(this)" }).Placeholder("Nombres")
                                    <div class="horizontal-space"></div>
                                </div>
                                <label class="col-sm-1 control-label">Apellidos <sup>*</sup></label>
                                <div class="col-md-2">
                                    @Html.Bootstrap().TextBox("apellidos").HtmlAttributes(new { @onkeyup = "InputToUpper(this)" }).Placeholder("Apellidos")
                                    <div class="horizontal-space"></div>
                                </div>
                                <div class="col-md-1">
                                    @Html.Bootstrap().Button().Text("Aperturar").Id("AperturarTraslado").Color(BootstrapColors.Darkorange).Shiny()
                                    <div class="horizontal-space"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="head03">
                            <div class="form-group">
                                <label class="col-sm-1 control-label">Codigo Qr <sup>*</sup></label>
                                <div class="col-md-4">
                                    @Html.Bootstrap().TextBox("Codigo").Placeholder("Codigo")
                                    @Html.Hidden("fk_conductor", 0)
                                    <div class="horizontal-space"></div>
                                </div>
                                <label class="col-sm-1 control-label">Mensaje </label>
                                <div class="col-md-4">
                                    @Html.Bootstrap().TextBox("Mensaje").HtmlAttributes(new { @style = "background-color:yellow" }).Disable().Placeholder("")
                                    <div class="horizontal-space"></div>
                                </div>
                            </div>
                        </div>
                        <div class="horizontal-space"></div>
                        <div class="row">
                            <div class="col-xs-12 col-md-12">
                                <div class="well with-header with-footer">
                                    <div class="header bordered-pink">
                                        Lecturas realizadas
                                    </div>
                                    <div class="table-scrollable" style="height: 250px; overflow: scroll">
                                        <table class="table table-striped table-bordered table-hover" id="tbCodigoQr">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <i class="fa fa-qrcode"></i> Id QR
                                                    </th>
                                                    <th class="hidden-xs">
                                                        <i class="fa fa-bars"></i> Id Palet
                                                    </th>
                                                    <th class="hidden-xs">
                                                        <i class="fa fa-barcode"></i> Producto
                                                    </th>
                                                    <th class="hidden-xs">
                                                        <i class="fa fa-barcode"></i> Empaque
                                                    </th>
                                                    <th class="hidden-xs">
                                                        <i class="fa fa-barcode"></i> Formato
                                                    </th>
                                                    <th class="hidden-xs">
                                                        <i class="fa fa-barcode"></i> Trazabilidad
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <div class="footer" style="align-items:center">
                                        <div class="col-md-10" style="text-align:right;vertical-align:middle;margin-top:8px">
                                            Cantidad: <span class="page-Title labelbultosEs" style="margin: 12px; margin-right:30px; color:blue; font-weight:bold;" id="cantidad">0</span>
                                        </div>
                                        <div class="col-md-2">
                                            @Html.Bootstrap().Button().Text("Cerrar Traslado").Id("CerrarTraslado").Color(BootstrapColors.Sky).Shiny()
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@section PageScripts{
    <script src="~/assets/js/validation/bootstrapValidator.js"></script>
    <script>
        var id_trasladoNew = 0;
        function InputToUpper(obj) {
            if (obj.value != "") {
                obj.value = obj.value.toUpperCase();
            }
        }
        $(document).ready(function () {
            var origenx = "0";
            try {
                origenx = $("#origen").val();
            }
            catch (e) {

            }
            if (origenx != "0") {
                LlenaZonas(origenx);
                LlenaDestino(origenx)
            }
            function isANumber(str) {
                return !/\D/.test(str);
            }
            function InputToUpper(obj) {
                if (obj.value != "") {
                    obj.value = obj.value.toUpperCase();
                }
            }
            $("#AperturarTraslado").click(function () {
                var id_traslado = 0;
                var fk_conductor = $("#fk_conductor").val();
                var fk_placa = $("#fk_placa").val();
                var placa = $("#placa").val();

                var origen = $("#origen").val();
                var fk_zona_embarque = $("#fk_zona_embarque").val();
                var destino = $("#destino").val();
                var precinto = $("#precinto").val();
                var dni = $("#dni").val();
                var brevete = $("#brevete").val();
                var nombres = $("#nombres").val();
                var apellidos = $("#apellidos").val();


                if (placa === '' || origen === 0 || fk_zona_embarque === '' || destino === 0 || precinto === '' || dni === '' || brevete === '' || nombres === '' || apellidos === '') {
                    sweetAlert("", "Datos Incompletos", "error");
                    $("#txt_contenedor").focus();
                    return false;
                }
                if (id_trasladoNew == 0) {
                    $.ajax({
                        type: 'POST',
                        //url: "SaveTraslado",
                        url: '@Url.Action("SaveTraslado", "Traslado")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({
                            fk_conductor: fk_conductor, fk_placa: fk_placa, placa: placa, origen: origen, fk_zona_embarque: fk_zona_embarque,
                            destino: destino, precinto: precinto, dni: dni, brevete: brevete, nombres: nombres, apellidos: apellidos
                        }),
                        dataType: 'json',
                        traditional: true,
                        success: function (data) {
                            console.log(data);
                            id_trasladoNew = data.id_traslado;
                            $("#btnAperturaEmbarque").prop('disabled', true);
                            $("#brevete").prop('disabled', true);
                            $("#nombres").prop('disabled', true);
                            $("#apellidos").prop('disabled', true);
                            $("#placa").prop('disabled', true);
                            $("#destino").prop('disabled', true);

                            $("#precinto").prop('disabled', true);
                            $("#dni").prop('disabled', true);

                            $("#head03 *").prop('disabled', false);
                            $("#footSave *").prop('disabled', false);


                            swal({
                                title: 'Exito!',
                                text: 'El Traslado N.- ' + data.codigo + ' se registró correctamente',
                                type: 'success',
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Empezar lecturas!'
                            }, function () {
                                CheckOpen(origen, fk_zona_embarque);
                            })
                        },
                        error: function (data) {
                            sweetAlert("", data.responseText, "error");
                            id_trasladoNew = 0;
                        }
                    });
                } else {
                    sweetAlert("", "Embarque ya Aperturado!", "error");
                }
                //REGISTRO DE CABECERA DE EMBARQUE
            }
                )
            $("#CerrarTraslado").click(function () {
                if (id_trasladoNew > 0) {
                    $.ajax({
                        type: 'POST',
                        //url: "CierraTraslado",
                        url: '@Url.Action("CierraTraslado", "Traslado")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({
                            id_trasladoNew: id_trasladoNew
                        }),
                        dataType: 'json',
                        traditional: true,
                        success: function (data) {
                            console.log(data);
                            id_trasladoNew = data.id_traslado;

                            swal({
                                title: 'Exito!',
                                text: 'El Traslado N.- ' + data.codigo + ' se cerró correctamente',
                                type: 'success',
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'OK!'
                            }, function () {
                                setTimeout(function () {
                                    location.reload()
                                }, 100);
                            })
                        },
                        error: function (data) {
                            sweetAlert("", data.responseText, "error");
                            id_trasladoNew = 0;
                        }
                    });
                } else {
                    sweetAlert("", "Embarque no esta aperturado o No se ha cargado uno!", "error");
                }
                //REGISTRO DE CABECERA DE EMBARQUE
            });
        });
        $("#origen").change(function () {
            var opcion = $(this).val();
            LlenaZonas(opcion);
            LlenaDestino(opcion)
        });
        $("#destino").change(function () {
            console.log("destino");
            var origenvalue = $("#origen").val();
            var destinopcion = $(this).val();
            if (origenvalue == destinopcion) {
                swal(
                  'Error',
                  'El destino no puede ser el origen!',
                  'warning'
                )
            }

        });
        function LlenaZonas(opcion) {
            $.ajax({
                type: 'POST',
                //url: "Filter_ZonaEmbarque",
                url: '@Url.Action("Filter_ZonaEmbarque", "Traslado")',
                data: JSON.stringify({ id: opcion }),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (response) {

                    $("#fk_zona_embarque").prop('disabled', false);
                    $('#fk_zona_embarque option').remove();
                    var dataLen = response.length;
                    $('#fk_zona_embarque').append('<option value=""></option>');
                    for (i = 0; i < dataLen; i++) {
                        $('#fk_zona_embarque').append('<option value="' + response[i].id + '">' + response[i].zona_embarque + '</option>');
                    }
                }
            });
        }
        function LlenaDestino(opcion) {
            $.ajax({
                type: 'POST',
                //url: "Filter_ZonaEmbarque",
                url: '@Url.Action("Filter_Destino", "Traslado")',
                data: JSON.stringify({ id: opcion }),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (response) {

                    $("#destino").prop('disabled', false);
                    $('#destino option').remove();
                    var dataLen = response.length;
                    $('#destino').append('<option value=""></option>');
                    for (i = 0; i < dataLen; i++) {
                        $('#destino').append('<option value="' + response[i].id + '">' + response[i].lugar + '</option>');
                    }
                }
            });
        }
        $('#dni').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            var node = (event.target)
            if (keycode == '13') {
                if (node.type != "submit") {
                    event.preventDefault();
                    var dni = $('#dni').val();

                    if (dni.length < 8) {
                        swal(
                          'Error',
                          'El numero de DNI esta incompleto!',
                          'warning'
                        )
                        //$('#dni').focus();
                    } else if (dni.length == 8) {
                        if (isANumber(dni)) {
                            TraeConductor(dni);
                        }
                    }
                }
            }
        });
        $('#dni').blur(function () {
            var dni = $('#dni').val();
            if (dni.length < 8) {
                swal(
                  'Error',
                  'El numero de DNI esta incompleto!',
                  'warning'
                )
                //$('#dni').focus();
            } else if (dni.length == 8) {
                if (isANumber(dni)) {
                    TraeConductor(dni);
                }
            }
        })
        function TraeConductor(dni) {
            $.ajax({
                type: 'POST',
                //url: "CheckConductor",
                url: '@Url.Action("CheckConductor", "Traslado")',
                data: JSON.stringify({ dni: dni }),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (response) {
                    var dataLen = 0;
                    try {
                        dataLen = response.IdConductor.toString();
                    } catch (e) {

                    }
                    if (parseInt(dataLen) <= 0) {
                        console.log("Mensaje respuesta: " + dataLen);
                        $("#fk_conductor").val(0);
                        $("#brevete").val('');
                        $("#nombres").val('');
                        $("#apellidos").val('');

                        $("#brevete").prop('disabled', false);
                        $("#nombres").prop('disabled', false);
                        $("#apellidos").prop('disabled', false);

                    } else {
                        //AQUI CARGO DATA
                        $("#fk_conductor").val(response.IdConductor);
                        $("#brevete").val(response.Brevete);
                        $("#nombres").val(response.Nombres);
                        $("#apellidos").val(response.Apellidos);

                        $("#brevete").prop('disabled', true);
                        $("#nombres").prop('disabled', true);
                        $("#apellidos").prop('disabled', true);

                        //$("#btnAperturaEmbarque").prop('disabled', true);
                    }

                }
            });
        }
        function isANumber(str) {
            return !/\D/.test(str);
        }
        $('#Codigo').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            var node = (event.target)
            if (keycode == '13') {
                if (node.type != "submit") {
                    event.preventDefault();
                    var texts = $("#Codigo").val();
                    console.log("texts: " + texts);
                    console.log("texts.charAt(0): " + texts.charAt(0));
                    var indexo = texts.indexOf(";ID:");
                    if (indexo >= 0) {
                    }
                    else if (texts.charAt(0) == "k") {
                        ExtraeCodigoGrupalShort();  //PENDIENTE
                    }
                    else {    /// -1
                        ExtraeCodigoIndividual();
                    }

                }
            }
        });

        function ExtraeCodigoIndividual() {
            var codigo = $("#Codigo").val();
            var txt_numeroxLeido = $("#txt_numeroxLeido").val();
            console.log("nroItems: " + txt_numeroxLeido);
            if (codigo.length > 0) {
                //
                $("#Mensaje").prop('disabled', true);
                $("#Mensaje").val('');
                var id = $("#Codigo").val();
                $.ajax({
                    type: "POST",
                    //url: "Get_CodigoQrData",
                    url: '@Url.Action("Get_CodigoQrData", "Traslado")',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({ id: id }),
                    dataType: "json",
                    success: function (response) {
                        var idTabla = "";
                        var cont = 0;
                        var dataLen = response.length;
                        if (dataLen > 0) {
                            //NO REPETIR
                            $("#tbCodigoQr tbody tr").each(function (index) {
                                var campo1, campo2, campo3;
                                $(this).children("td").each(function (index2) {
                                    switch (index2) {
                                        case 0: campo1 = $(this).text();
                                            break;
                                    }
                                    if (campo1 == response[0]) {
                                        cont = cont + 1;
                                    }
                                })
                            })
                            //NO REPETIR
                            if (cont == 0) {
                                var row = $("<tr id='tr" + nroItems + "'>" +
                                    "<td width='15%'>" + response[0] + "</td>" +
                                    "<td width='5%'>" + response[11] + "</td>" +
                                    "<td width='65%'>" + response[3] + "</td>" +
                                    "<td width='5%'>" + response[4] + "</td>" +
                                    "<td width='5%'>" + response[5] + "</td>" +
                                    "<td width='5%'>" + response[7] + "</td>" +
                                    "</tr>");
                                SaveDetalleTraslado(id_trasladoNew, response[0], response[11]);
                                nroItems = nroItems + 1;
                                $("#tbCodigoQr").append(row);

                            } else {
                                $("#Mensaje").prop('disabled', true);
                                $("#Mensaje").val('');
                                $("#Mensaje").val('BULTO YA LEIDO');
                            }
                            $('#cantidad').replaceWith("<span class='page-Title labelbultosEs' style='margin: 10px; margin-right:30px; color:blue' id='cantidad'>" + nroItems + "</span>");
                            $("#txt_numeroxLeido").val(nroItems);
                            $("#Codigo").val('');
                            $("#Codigo").focus();
                        } else {

                        }
                    },
                    error: function (data) {
                        $("#Mensaje").prop('disabled', true);
                        $("#Mensaje").val('');
                        $("#Mensaje").val(data.responseText);
                        $("#Codigo").val('');
                        $("#Codigo").focus();
                    }

                });
            } else {
                swal("Error", "El Qr No existe", "error");
                $("#Codigo").focus();
            }
        }

        function ExtraeCodigoGrupalShort() {
            var texto = $("#Codigo").val();
            var txt_IdProducto = $("#txtIdProducto").val();
            var txt_IdFormato = $("#txtIdFormato").val();
            var txt_Traza = $("#txtTraza").val();
            var txt_numerox = $("#txt_numero").val();
            if (texto.length > 0) {
                var FkEmbarqueExportacion = $("#fk_embarque_exportacion").val();
                var Fila = $("#txtFila").val();
                //
                $("#Mensaje").prop('disabled', true);
                $("#Mensaje").val('');
                var id = $("#Codigo").val();
                $.when($.ajax({
                    type: "POST",
                    //url: "Get_CodigoQrPallet",
                    url: '@Url.Action("Get_CodigoQrPallet", "Traslado")',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({ id: id }),
                    dataType: "json",
                    success: function (response) {
                        var idTabla = "";
                        var cont = 0;
                        var contCond = 0;
                        var dataLen = response.length;
                        if (dataLen > 0) {
                            var contBulto = 0;
                            for (var i = 0; i < dataLen; i++) {
                                //NO REPETIR
                                $("#tbCodigoQr tbody tr").each(function (index) {
                                    var campo1, campo2, campo3;
                                    $(this).children("td").each(function (index2) {
                                        switch (index2) {
                                            case 0: campo1 = $(this).text();
                                                //console.log("campo1:" + campo1);
                                                break;
                                        }
                                        if (campo1 == response[i].Id) {
                                            cont = cont + 1;
                                            console.log("cont:" + cont);
                                        }
                                    })
                                })
                                //NO REPETIR
                                if (cont == 0) {

                                    var row = $("<tr id='tr" + nroItems + "'>" +
                                    "<td width='15%'>" + response[i].Id + "</td>" +
                                    "<td width='5%'>" + response[i].QrId + "</td>" +
                                    "<td width='65%'>" + response[i].Producto + "</td>" +
                                    "<td width='5%'>" + response[i].Empaque + "</td>" +
                                    "<td width='5%'>" + response[i].Formato + "</td>" +
                                    "<td width='5%'>" + response[i].Trazabilidad + "</td>" +
                                    "</tr>");

                                    nroItems = nroItems + 1;
                                    $("#tbCodigoQr").append(row);
                                    SaveDetalleTraslado(id_trasladoNew, response[i].Id, response[i].QrId);
                                    contBulto++;
                                    console.log("nroItems: " + nroItems);
                                    $('#cantidad').replaceWith("<span class='page-Title labelbultosEs' style='margin: 10px; margin-right:30px; color:blue' id='cantidad'>" + nroItems + "</span>");
                                } else {
                                    //    $("#Mensaje").prop('disabled', true);
                                    //    $("#Mensaje").val('');
                                    //    $("#Mensaje").val('PRODUCTO NO PERTENECE');
                                }
                            }
                            $('#cantidad').replaceWith("<span class='page-Title labelbultosEs' style='margin: 10px; margin-right:30px; color:blue' id='cantidad'>" + nroItems + "</span>");
                            $("#Codigo").val('');
                            $("#Codigo").focus();
                            $("#txt_numeroxLeido").val(nroItems);
                        }
                    },
                    error: function (data) {

                        $("#Mensaje").prop('disabled', true);
                        $("#Mensaje").val('');
                        $("#Mensaje").val(data.responseText);
                        $("#Codigo").val('');
                        $("#Codigo").focus();
                        setTimeout(function () { alert(data.responseText); }, 1000);
                    }

                })).then(function (response) {
                    return response;
                });
            } else {
                swal("Error", "El Qr Pallet no presenta Codigo Interno", "error");
                $("#Codigo").focus();
            }

        }
        $("#fk_zona_embarque").change(function () {
            if (typeof String.prototype.startsWith != 'function') {
                String.prototype.startsWith = function (str) {
                    return this.substring(0, str.length) === str;
                }
            };

            var lugar = $("#origen").val();
            var zona = $("#fk_zona_embarque").val();
            var search = 'Excepcion';
            CheckOpen(lugar, zona);
        });
        function CheckOpen(lugar, zona) {
            $.ajax({
                type: 'POST',
                //url: "CheckOpenTraslado",
                url: '@Url.Action("CheckOpenTraslado", "Traslado")',
                data: JSON.stringify({ fk_lugar_embarque: lugar, fk_zona_embarque: zona }),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (response) {
                    var dataLen = 0;

                    try {
                        dataLen = response.IdTraslado.toString();
                    } catch (e) {

                    }

                    if (parseInt(dataLen) <= 0) {
                        console.log("Mensaje respuesta: " + response);
                        $("#destino").val('');
                        $("#destino").prop('disabled', false);
                        $("#fk_placa").val(0);
                        $("#placa").val('');
                        $("#placa").prop('disabled', false);
                        $("#precinto").val('');
                        $("#precinto").prop('disabled', false);
                        $("#fk_conductor").val(response.FkConductor);
                        $("#dni").val(response.DNI);
                        $("#dni").prop('disabled', false);
                        $("#brevete").val(response.Brevete);
                        $("#brevete").prop('disabled', false);
                        $("#nombres").val(response.Nombres);
                        $("#nombres").prop('disabled', false);
                        $("#apellidos").val(response.Apellidos);
                        $("#apellidos").prop('disabled', false);
                        $("#btnAperturaTraslado").prop('disabled', false);

                        $("#head03 *").prop('disabled', true);
                        $("#footSave *").prop('disabled', true);
                        $("#tbCodigoQr *").prop('disabled', true);
                        $("#Mensaje").val('');
                        nroItems = 0;
                        id_trasladoNew = 0;
                        $('#cantidad').replaceWith("<span class='page-Title labelbultosEs' style='margin: 10px; margin-right:30px; color:blue' id='cantidad'>" + nroItems + "</span>");
                        $("#tbCodigoQr tbody tr").remove();

                    } else {
                        //AQUI CARGO DATA
                        console.log("Mensaje respuesta: " + JSON.stringify(response));
                        $("#destino").val(response.FkDestino);
                        $("#destino").prop('disabled', true);
                        $("#fk_placa").val(response.FkPlaca);
                        $("#placa").val(response.Placa);
                        $("#placa").prop('disabled', true);
                        $("#precinto").val(response.Precinto);
                        $("#precinto").prop('disabled', true);
                        $("#fk_conductor").val(response.FkConductor);
                        $("#dni").val(response.DNI);
                        $("#dni").prop('disabled', true);
                        $("#brevete").val(response.Brevete);
                        $("#brevete").prop('disabled', true);
                        $("#nombres").val(response.Nombres);
                        $("#nombres").prop('disabled', true);
                        $("#apellidos").val(response.Apellidos);
                        $("#apellidos").prop('disabled', true);
                        $("#btnAperturaTraslado").prop('disabled', true);

                        $("#head03 *").prop('disabled', false);
                        $("#footSave *").prop('disabled', false);

                        id_trasladoNew = response.IdTraslado;

                        $("#tbCodigoQr *").prop('disabled', false);
                        $("#tbCodigoQr tbody tr").remove();
                        CargaDetalles(id_trasladoNew);
                        $('#Codigo').focus();
                    }
                }
            });
        }
        function CargaDetalles(id_trasladoNew) {
            nroItems = 0;
            var dataleni = 0;
            $.ajax({
                type: 'POST',
                //url: "CargaDetalles",
                url: '@Url.Action("CargaDetalles", "Traslado")',
                data: JSON.stringify({ id_trasladoNew: id_trasladoNew }),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (response) {
                    var dataLen = 0;
                    var cont = 0;
                    //console.log("objetos: " + JSON.stringify(response));
                    //console.log("responsecarga: " + JSON.stringify(response[0].IdCodigo));
                    try {
                        dataLen = JSON.stringify(response[0].IdCodigo);
                        dataLen = dataLen.length;
                        console.log("dataLen: " + dataLen);
                        dataleni = parseInt(dataLen);
                        console.log("dataleni: " + dataleni);
                    } catch (e) {
                        console.log("e: " + e.message);
                    }
                    if (parseInt(dataLen) <= 0) {
                        console.log("Mensaje respuesta Carga: " + dataLen);
                        $("#tbCodigoQr tbody tr").remove();

                    } else {
                        //AQUI CARGO DATA
                        $("#tbCodigoQr tbody tr").remove();

                        var contBulto = 0;
                        for (var i = 0; i < dataLen; i++) {
                            //NO REPETIR
                            $("#tbCodigoQr tbody tr").each(function (index) {
                                var campo1, campo2, campo3;
                                $(this).children("td").each(function (index2) {
                                    switch (index2) {
                                        case 0: campo1 = $(this).text();
                                            break;
                                    }
                                    if (campo1 == response[i].IdCodigo) {
                                        cont = cont + 1;
                                        console.log("cont:" + cont);
                                    }
                                })
                            })
                            //NO REPETIR
                            if (cont == 0) {

                                var row = $("<tr id='tr" + nroItems + "'>" +
                                "<td>" + response[i].IdCodigo + "</td>" +
                                "<td class='hidden-xs'>" + response[i].FkQrPalet + "</td>" +
                                "<td class='hidden-xs'>" + response[i].Producto + "</td>" +
                                "<td class='hidden-xs'>" + response[i].Empaque + "</td>" +
                                "<td class='hidden-xs'>" + response[i].Formato + "</td>" +
                                "<td class='hidden-xs'>" + response[i].Trazabilidad + "</td>" +
                                "</tr>");

                                nroItems = nroItems + 1;
                                $("#tbCodigoQr").append(row);
                                contBulto++;
                                console.log("nroItems: " + nroItems);
                                $('#cantidad').replaceWith("<span class='page-Title labelbultosEs' style='margin: 10px; margin-right:30px; color:blue' id='cantidad'>" + nroItems + "</span>");
                            } else {
                            }
                        }
                        $('#cantidad').replaceWith("<span class='page-Title labelbultosEs' style='margin: 10px; margin-right:30px; color:blue' id='cantidad'>" + nroItems + "</span>");
                        $("#Codigo").val('');
                        $("#Codigo").focus();
                        $("#txt_numeroxLeido").val(nroItems);


                    }

                }
            });
        }
        function SaveDetalleTraslado(id_trasladoNew, codigoqr, qrpaletid) {
            $.when($.ajax({
                type: 'POST',
                //url: "SaveDetalleTraslado",
                url: '@Url.Action("SaveDetalleTraslado", "Traslado")',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    id_trasladoNew: id_trasladoNew, codigoqr: codigoqr, qrpaletid: qrpaletid
                }),
                dataType: 'json',
                traditional: true,
                success: function (response) {

                    var idTabla = "";
                    var cont = 0;
                    var dataLen = response.length;
                    console.log("dataLen save: " + response);
                    if (response[0] == '9') {
                        $("#Mensaje").prop('disabled', true);
                        $("#Mensaje").val('');
                        $("#Mensaje").val('La secuencia no contiene elementos!');
                        $("#Codigo").focus();
                        $("#txtExist").val(0);
                    } else if (response[0] == '1') {
                        console.log("response[0]: " + response[0]);
                        $("#Mensaje").val('Registrado!');
                    }
                },
                error: function (data) {
                    sweetAlert("", data.responseText, "error");
                }
            })).then(function (response) {
                return response;
            });
        }

    </script>
}