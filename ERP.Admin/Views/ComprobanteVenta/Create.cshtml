<script type="text/javascript">
    var NroTrVD = 1;
    var NroTrMP = 1;
    var arrSaveIDGuiaRemi = new Array();
    var IdTRDistribuir = "";
    var CantDistribuir = 0;
    var NombProdDistribuir = "";
    var vgEstaVent = 1; // 1 => Registra en movimiento, 2 => Venta por regularizar (No registra en movimiento)
    var vgFlgSaveNewCliente = 0; // 1 = Guardar el cliente como nuevo
    var arraCVIdPedi = new Array();
    var ofktipob = 'IGV';

    var exonerada = 0;
    var inafecta = 0;
    var gratuita = 0;


    function FnAgregaVentaDetalle(IdPedi, FkClie, FkClieTipo, NroPedi, DniRuc, NombRazoSoci, FkUserVent, NombUserVent, PediTotaNeto,
        PediTotaIgv, PediTotaBruto, arrVentDeta, arraIdPedi, ClieEmail) {
        vgEstaVent = 1;
        NroTrVD = 1;

        //alert(arraIdPedi.length);
        $("#txtVentNew_FkPedi").val(IdPedi);
        $("#txtVentNew_NroPedi").val(NroPedi);
        $("#txtVentNew_FkClie").val(FkClie);
        $("#txtVentNew_FkClieTipo").val(FkClieTipo);
        $("#txtVentNew_DniRucClie").val(DniRuc);
        $("#txtVentNew_NombRazoSocialClie").val(NombRazoSoci);
        $("#txtVentNew_EmailClie").val(ClieEmail);
        $("#txtVentNew_FkUsuaVent").val(FkUserVent);
        document.getElementById("lblVentNew_NombUsuaVent").innerHTML = "Pedido registrado por: " + NombUserVent;
        arraCVIdPedi = arraIdPedi;
        $("#btnAddClie").prop('disabled', false);

        var radios = document.getElementsByName("radioMedioPago");
        for (var i = 0, iLen = radios.length; i < iLen; i++) {
            radios[i].disabled = false;
        }
        $("#txtCompCompNew_EfecReci").prop('disabled', false);

        $("#tBodyVentDetalle tr").remove();
        for (var j = 0; j < arrVentDeta.length; j++) {
            AddTRTableGuiaDetalle(arrVentDeta[j][0], arrVentDeta[j][1], arrVentDeta[j][2], arrVentDeta[j][3], arrVentDeta[j][4],
                arrVentDeta[j][5], arrVentDeta[j][6], arrVentDeta[j][7], arrVentDeta[j][8], arrVentDeta[j][9], arrVentDeta[j][10],
                arrVentDeta[j][11], arrVentDeta[j][12], arrVentDeta[j][13], arrVentDeta[j][7], arrVentDeta[j][7]);
        }
        document.getElementById("TDCompVentTotaNeto").innerHTML = parseFloat(PediTotaNeto).toFixed(2);
        document.getElementById("TDCompVentTotaIgv").innerHTML = parseFloat(PediTotaIgv).toFixed(2);
        document.getElementById("TDCompVentTotaBrutoP").innerHTML = parseFloat(PediTotaBruto).toFixed(2);
        document.getElementById("TDCompVentTotaBruto").innerHTML = parseFloat(PediTotaBruto).toFixed(2);
        $('#btnAddProd').prop('disabled', false);
        vgFlgSaveNewCliente = 0;
        FnResetAlmacen();
        FnGetCorrelativo();
        //FnValidaStockDisponible();
        $("#txtCompCompNew_EfecReci").focus();
    }

    function FnInputDataNotaCredito(IdNotaCred, NroNotaCred, MontDisp) {
        $("#txtVentNew_NroCheqVoucNotaCred").val(NroNotaCred);
        $("#txtVentNew_FkNotaCred").val(IdNotaCred);
        $("#txtCompCompNew_MontMediPago").val(MontDisp);
    }

    function FnAgregaNeProductoVentaDetalle(arrVentDeta) {
        debugger;
        var pCant = 1;
        var pBruto = parseFloat(pCant) * parseFloat(arrVentDeta[4]);
        var tempigv = CalculaIgvMas(pBruto, 18);
        pBruto = parseFloat(pBruto) + parseFloat(tempigv);
        var pTotaIgv = 0;
        if (arrVentDeta[5].trim() == "1") {
            //pTotaIgv = parseFloat(CalculaIgv(pBruto, 18)).toFixed(2);
            pTotaIgv = parseFloat(tempigv).toFixed(2);

        }
        //var pTotaNeto = parseFloat(pBruto - pTotaIgv).toFixed(2);
        var pTotaNeto = parseFloat(pBruto).toFixed(2);

        AddTRTableGuiaDetalle(arrVentDeta[0], arrVentDeta[1], arrVentDeta[2], arrVentDeta[3], arrVentDeta[4], pTotaNeto, pTotaIgv, pBruto, 1,
            arrVentDeta[5], 18, arrVentDeta[4], pCant, arrVentDeta[6]);
        FnCalculaTotaleComprobanteVenta();
    }

    function FnValidaExisteProducto2(FkProd, tipobien) {
        var opttiposx = $("#cmbTipoProduc").val();
        console.log("opttiposx: ", opttiposx);
        if (opttiposx != tipobien) {
            rptaReturn = 2;
            return false;
        }
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var newFkPro = "";
        var rptaReturn = 0;
        var tipoxxx = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    newFkPro = document.getElementById("TDFkProd" + newTr).innerHTML;
                    tipoxxx = document.getElementById("TDHiddTipoBien" + newTr).innerHTML;
                    if (parseInt(FkProd) == parseInt(newFkPro) && tipoxxx == tipobien) {
                        rptaReturn = 1;
                        break;
                    }

                }
            }
        }
        return rptaReturn;
    }

    function FnValidaExisteProducto(FkProd) {


        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var newFkPro = "";
        var rptaReturn = 0;
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    newFkPro = document.getElementById("TDFkProd" + newTr).innerHTML;
                    if (parseInt(FkProd) == parseInt(newFkPro)) {
                        rptaReturn = 1;
                        break;
                    }
                }
            }
        }
        return rptaReturn;
    }

    function AddTRTableGuiaDetalle(pFkProd, pCodiProd, pFkEmpre, pNombProd, pPrec, pTotaNeto,
        pTotaIgv, pTotaBruto, pFkTipoAfecIgv, pFlgAfecIgv, pPorcIgv, pPrecUnit, pCant, tipobien) {
        //debugger;
        var IdTrVD = "IdTrVD" + NroTrVD;
        var TDFkProd = "TDFkProd" + IdTrVD;
        var TDCodiProd = "TDCodiProd" + IdTrVD;
        var TDBtnAddAlma = "TDBtnAddAlma" + IdTrVD;
        var TDStrDist = "TDStrDist" + IdTrVD;
        var TDNombProd = "TDNombProd" + IdTrVD;
        var TDIgvSelecProd = "TDIgvSelecProd" + IdTrVD;
        var TDCant = "TDCant" + IdTrVD;
        var TDCodSunat = "TDCodSunat" + IdTrVD;
        var TDPrec = "TDPrec" + IdTrVD;
        var TDTotaNeto = "TDTotaNeto" + IdTrVD;
        var TDTotaIgv = "TDTotaIgv" + IdTrVD;
        var TDTotaBruto = "TDTotaBruto" + IdTrVD;
        var TDBtnDeleteDeta = "TDBtnDeleteDeta" + IdTrVD;
        var TDFkTipoAfecIgv = "TDFkTipoAfecIgv" + IdTrVD;
        var TDFlgAfecIgv = "TDFlgAfecIgv" + IdTrVD;
        var TDPorcIgv = "TDPorcIgv" + IdTrVD;
        var TDHiddPrecUnit = "TDHiddPrecUnit" + IdTrVD;
        var TDHiddPrecMayo = "TDHiddPrecMayo" + IdTrVD;
        var TDHiddPorRegu = "TDHiddPorRegu" + IdTrVD;
        var TDHiddTipoIna = "TDHiddTipoIna" + IdTrVD;
        var TDHiddTipoBien = "TDHiddTipoBien" + IdTrVD;

        var strBtnAddAlma = '@Html.Bootstrap().Button().Text("Seleccione").Color(BootstrapColors.Success).Size(ButtonSize.Mini).HtmlAttributes(new { @onclick = "FnAddAlmacen(this)" })';
        var strTxtCant = '@Html.Bootstrap().TextBox("txtCant").Size(InputSize.XSmall).HtmlAttributes(new { @onchange = "FnValidaCantidad(this)", @onfocus = "this.oldvalue = this.value;", @type = "number", @min = "0", @style = "text-align: right;border-radius: 6px !important;height: 25px" })';
        var strTxtCodSunat = '@Html.Bootstrap().TextBox("txtCodSunat").Size(InputSize.XSmall).HtmlAttributes(new { @onfocus = "this.oldvalue = this.value;", @type = "text", @style = "text-align: center;border-radius: 6px !important;height: 25px" })';
        var strTxtPrec = '@Html.Bootstrap().TextBox("txtPrec").Size(InputSize.XSmall).HtmlAttributes(new { @onchange = "FnValidaPrecio(this)", @onfocus = "this.oldvalue = this.value;", @type = "number", @min = "0", @style = "text-align: right;border-radius: 6px !important;height: 25px" })';
        var strBtnDeta= '@Html.Bootstrap().Button().Text("").Color(BootstrapColors.Default).HtmlAttributes(new { @class = "danger", @title="Eliminar Detalle", @onclick = "FnDeleteDetalle(this)" }).Shiny().Size(ButtonSize.Mini).IconOnly().IconPrepend(FontAwesome.Times)';

        var row = $("<tr id='" + IdTrVD + "'>" +
            "<td id='" + TDFkProd + "' class='input-xs' style='display: none;'>" + pFkProd + "</td>" +
            "<td id='" + TDBtnAddAlma + "' class='input-xs' style='width: 10%; text-align: center; display: none;'>" + strBtnAddAlma + "</td>" +
            "<td id='" + TDStrDist + "' class='input-xs' style='display: none;'></td>" +
            "<td id='" + TDCodiProd + "'  class='input-xs' style='text-align: center;'>" + pCodiProd + "</td>" +
            "<td id='" + TDCodSunat + "' class='input-xs' style='text-align: right;'>" + strTxtCodSunat + "</td>" +
            "<td class='input-xs' style='text-align: center; display: none;'>" + pFkEmpre + "</td>" +
            //"<td id='" + TDNombProd + "' class='input-xs'>" + pNombProd + "</td>" +

            "<td id='" + TDNombProd + "' class='input-xs'><textarea rows='2' id='e-" + TDNombProd + "' style='width:100%; border-radius: 6px !important;'>" + pNombProd +" </textarea> </td>" +
            "<td id='' class='input-xs'>"+
                "<select name='" + TDIgvSelecProd + "' id='" + TDIgvSelecProd + "' style='border-radius:6px !important' onchange='FnSetTaxes(this)'>"+
                    "<option value='18|1|IGV'>Gravado Operación Onerosa</option>"+
                    "<option value='0|2|GRA'>[Gratuito] Gravado Retiro por premio</option>"+
                    "<option value='0|3|GRA'>[Gratuito] Gravado Retiro por donación</option>"+
                    "<option value='0|4|GRA'>[Gratuito] Gravado Retiro</option>"+
                    "<option value='0|5|GRA'>[Gratuito] Gravado Retiro por publicidad</option>"+
                    "<option value='0|6|GRA'>[Gratuito] Gravado Bonificaciones</option>" +
                    "<option value='0|7|GRA'>[Gratuito] Gravado Retiro por entrega a trabajadores</option>" +
                    "<option value='0|8|EXO'>Exonerado Operación Onerosa</option>"+
                    "<option value='0|9|INA'>Inafecto Operación Onerosa</option>"+
                    "<option value='0|10|GRA'>[Gratuito] Inafecto Retiro por Bonificación</option>"+
                    "<option value='0|11|GRA'>[Gratuito] Inafecto Retiro</option>"+
                    "<option value='0|12|GRA'>[Gratuito] Inafecto Retiro por Muestras Médicas</option>"+
                    "<option value='0|13|GRA'>[Gratuito] Inafecto Retiro por Convenio Colectivo</option>"+
                    "<option value='0|14|GRA'>[Gratuito] Inafecto Retiro por premio</option>"+
                    "<option value='0|15|GRA'>[Gratuito] Inafecto Retiro por publicidad</option>"+
                    "<option value='0|16|INA'>Exportación</option>"+
                "</select>"+
            "</td>"+
            //"<td id='" + TDCant + "' class='input-xs' style='text-align: right;'>" + pCant + "</td>" +
            "<td id='" + TDCant + "' class='input-xs' style='text-align: right;'>" + strTxtCant + "</td>" +
            //"<td id='" + TDPrec + "' class='input-xs' style='text-align: right;'>" + pPrec + "</td>" +
            "<td id='" + TDPrec + "' class='input-xs' style='text-align: right;'>" + strTxtPrec + "</td>" +
            "<td id='" + TDTotaNeto + "' class='input-xs' style='text-align: right;'>" + pTotaNeto + "</td>" +
            "<td id='" + TDTotaIgv + "' class='input-xs' style='text-align: right;'>" + pTotaIgv + "</td>" +
            "<td id='" + TDTotaBruto + "' class='input-xs' style='text-align: right;'>" + pTotaBruto + "</td>" +
            "<td id='" + TDBtnDeleteDeta + "' class='input-xs' style='text-align: center;'>" + strBtnDeta + "</td>" +
            "<td id='" + TDFkTipoAfecIgv + "' class='input-xs' style='display: none;'>" + pFkTipoAfecIgv + "</td>" +
            "<td id='" + TDFlgAfecIgv + "' class='input-xs' style='display: none;'>" + pFlgAfecIgv + "</td>" +
            "<td id='" + TDPorcIgv + "' class='input-xs' style='display: none;'>" + pPorcIgv + "</td>" +
            "<td id='" + TDHiddPrecUnit + "' class='input-xs' style='display: none;'>" + pPrecUnit + "</td>" +
            "<td id='" + TDHiddPorRegu + "' class='input-xs' style='display: none;'>1</td>" +
            "<td id='" + TDHiddTipoIna + "' class='input-xs' style='display: none;'>IGV</td>" +
            "<td id='" + TDHiddTipoBien + "' class='input-xs' style='display: none;'>" + tipobien + "</td>" +
            "</tr>");
        $("#tBodyVentDetalle").append(row);
        var objTxt = document.getElementById(TDCant).children;
        objTxt[0].value = pCant;
        objTxt = document.getElementById(TDPrec).children;
        objTxt[0].value = pPrec;
        NroTrVD++;
    }

    function FnDeleteDetalle(obj) {
        var IdTRsele = obj.parentElement.parentElement.id;
        var tr = $("#" + IdTRsele);
        tr.remove();
        FnCalculaTotaleComprobanteVenta();
    }

    function FnValidaPrecio(obj) {
        var IdTRsele = obj.parentElement.parentElement.id;
        var newPrec = parseInt(obj.value);
        if (newPrec <= 0) {
            sweetAlert("", "Precio no válido", "error");
            obj.value = obj.oldvalue;
        } else {
            FnCalculaSubtotal(IdTRsele);
        }
    }

    function FnValidaCantidad(obj) {
        debugger;
        var IdTRsele = obj.parentElement.parentElement.id;
        var newCant = parseInt(obj.value);
        var newPrec = 0;
        if (newCant <= 0) {
            sweetAlert("", "Cantidad no válida", "error");
            obj.value = obj.oldvalue;
        }
        else {
            var PrecUnitMayo = 0;
            //if (newCant >= 3) {
            //    PrecUnitMayo = document.getElementById("TDHiddPrecMayo" + IdTRsele).innerHTML.trim();
            //}
            //else {
                PrecUnitMayo = document.getElementById("TDHiddPrecUnit" + IdTRsele).innerHTML.trim();
           /* }*/
            var objTxt = document.getElementById("TDPrec" + IdTRsele).children;
            objTxt[0].value = PrecUnitMayo;
            FnCalculaSubtotal(IdTRsele);
        }
    }

    function FnSetTaxes(obj) {
        debugger;
        var IdTRsele = obj.parentElement.parentElement.id;
        var strall = obj.value;
        var res = strall.split("|");
        var oporc = res[0];
        var ofktipoa = res[1];
        ofktipob = res[2];
        //var newPorc = parseInt(obj.value);
        var newPorc = parseInt(oporc);
        var newFkTipo = parseInt(ofktipoa);
        var newPrec = 0;

        document.getElementById("TDPorcIgv" + IdTRsele).innerHTML = parseFloat(newPorc).toFixed(2);
        document.getElementById("TDFkTipoAfecIgv" + IdTRsele).innerHTML = newFkTipo;



        var newTdCant = document.getElementById("TDCant" + IdTRsele).children;
        var newCant = newTdCant[0].value;

        var newTdPrec = document.getElementById("TDPrec" + IdTRsele).children;
        var newPrec = newTdPrec[0].value;

        //var newNeto = parseFloat(parseFloat(newCant) * parseFloat(newPrec)) / (parseFloat(1) + parseFloat(parseFloat(newPorc) / parseFloat(100)));
        var newNeto = parseFloat(parseFloat(newCant) * parseFloat(newPrec));
        document.getElementById("TDTotaNeto" + IdTRsele).innerHTML = parseFloat(newNeto).toFixed(2);

        //var igv = parseFloat(parseFloat(newCant) * parseFloat(newPrec)) - parseFloat(newNeto);
        var igv = parseFloat(CalculaIgvMas(newNeto, newPorc));
        document.getElementById("TDTotaIgv" + IdTRsele).innerHTML = parseFloat(igv).toFixed(2);

        document.getElementById("TDHiddTipoIna" + IdTRsele).innerHTML = ofktipob ;

        var newBruto = parseFloat(newNeto) + parseFloat(igv);
        document.getElementById("TDTotaBruto" + IdTRsele).innerHTML = parseFloat(newBruto).toFixed(2);
        


        FnCalculaTotaleComprobanteVenta();
    }

    function FnValidaDetrax(obj) {
        debugger;
        //var IdTRsele = obj.parentElement.parentElement.id;
        var newCant = parseFloat(obj.value);
        var newBruto = document.getElementById("TDCompVentTotaBrutoP").value;
        newBruto = parseFloat(newBruto);
        var newnewDetrPor = 0;
        //var newnewDetrPor = 0;
        var newTotaBruto = 0;
        if (newCant < 0) {
            //sweetAlert("", "Cantidad no válida", "error");
            //obj.value = obj.oldvalue;
        }
        else {
            if (newBruto < 0) {

            } else {
                newnewDetrPor = parseFloat(newCant) / parseFloat(100);
                FnCalculaTotaleComprobanteVenta();
            }

        }
    }

    function FnCalculaSubtotal(IdTRsele) {
        debugger;
        var objTxt = document.getElementById("TDCant" + IdTRsele).children;
        var newCant = objTxt[0].value;
        objTxt = document.getElementById("TDPrec" + IdTRsele).children;
        var newPrec = objTxt[0].value;

        var newFlgAfecIgv = "";
        var newTotaBruto = 0;
        var newTotaNeto = 0;
        var newTotaIgv = 0;
        var newPorcIgv = 0;

        newPorcIgv = document.getElementById("TDPorcIgv" + IdTRsele).innerHTML;
        newTotaBruto = (parseFloat(newCant) * parseFloat(newPrec)).toFixed(2);
        var tempigv = CalculaIgvMas(newTotaBruto, newPorcIgv);
        newTotaBruto = parseFloat(newTotaBruto) + parseFloat(tempigv);

        newFlgAfecIgv = document.getElementById("TDFlgAfecIgv" + IdTRsele).innerHTML;
        if (newFlgAfecIgv.trim() == "1") {
            
            //newTotaIgv = CalculaIgv(newTotaBruto, newPorcIgv);
            newTotaIgv = CalculaIgvMas(newTotaBruto, newPorcIgv);
            newTotaIgv = tempigv;
        }
        newTotaNeto = newTotaBruto - newTotaIgv;

        document.getElementById("TDTotaNeto" + IdTRsele).innerHTML = parseFloat(newTotaNeto).toFixed(2);
        document.getElementById("TDTotaIgv" + IdTRsele).innerHTML = parseFloat(newTotaIgv).toFixed(2)
        document.getElementById("TDTotaBruto" + IdTRsele).innerHTML = parseFloat(newTotaBruto).toFixed(2)
        FnCalculaTotaleComprobanteVenta();
    }

    function FnCalculaTotaleComprobanteVenta() {
        debugger;
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var newTotaNeto = "";
        var newTotaIgv = "";
        var newTotaBruto = "";
        var ventSumaTotaNeto = 0;
        var ventSumaTotaIgv = 0;
        var ventSumaTotaBruto = 0;

        var newDetraPorc = "";
        var newTotaDetra = "";
        var ventSumaTotaBrutoP = 0;

        var tipoinao = "";
        var gratuita = 0;
        var exonerada = 0;
        var inafecta = 0;


        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {

                    tipoinao = document.getElementById("TDHiddTipoIna" + newTr).innerHTML;
                    newTotaNeto = document.getElementById("TDTotaNeto" + newTr).innerHTML;
                    newTotaIgv = document.getElementById("TDTotaIgv" + newTr).innerHTML;
                    newTotaBruto = document.getElementById("TDTotaBruto" + newTr).innerHTML;
                    if (tipoinao === 'GRA') {
                        gratuita = parseFloat(gratuita) + parseFloat(newTotaNeto);
                    }
                    else if (tipoinao === 'EXO') {
                        exonerada = parseFloat(exonerada) + parseFloat(newTotaNeto);
                    }
                    else if (tipoinao === 'INA') {
                        inafecta = parseFloat(inafecta) + parseFloat(newTotaNeto);
                    } else {
                        ventSumaTotaNeto = parseFloat(ventSumaTotaNeto) + parseFloat(newTotaNeto);
                    }

                    ventSumaTotaIgv = parseFloat(ventSumaTotaIgv) + parseFloat(newTotaIgv);
                    ventSumaTotaBruto = parseFloat(ventSumaTotaBruto) + parseFloat(newTotaBruto);
                    ventSumaTotaBrutoP = parseFloat(ventSumaTotaBrutoP) + parseFloat(newTotaBruto);
                    //ventSumaTotaBrutoP = parseFloat(ventSumaTotaBruto) - parseFloat(gratuita);


                }
            }

            document.getElementById("TDCompVentTotaExo").innerHTML = exonerada.toFixed(2);
            document.getElementById("TDCompVentTotaIna").innerHTML = inafecta.toFixed(2);
            document.getElementById("TDCompVentTotaGra").innerHTML = gratuita.toFixed(2);


            ventSumaTotaBruto = parseFloat(ventSumaTotaBrutoP) - parseFloat(gratuita) - parseFloat(exonerada) - parseFloat(inafecta);

            document.getElementById("TDCompVentTotaNeto").innerHTML = ventSumaTotaNeto.toFixed(2);
            document.getElementById("TDCompVentTotaIgv").innerHTML = ventSumaTotaIgv.toFixed(2);

            document.getElementById("TDCompVentTotaBrutoP").innerHTML = ventSumaTotaBruto.toFixed(2);

            //newDetraPorc = document.getElementById("txtCompCompNew_MontDetraccion").value;
            newDetraPorc = document.getElementById("txtCompCompNew_MontDetraccion").innerHTML;



            newTotaDetra = parseFloat(ventSumaTotaBruto) * (parseFloat(newDetraPorc) / parseFloat(100));
            document.getElementById("TDCompVentTotaDetra").innerHTML = newTotaDetra.toFixed(2);

            ventSumaTotaBruto = parseFloat(ventSumaTotaBruto) - parseFloat(newTotaDetra);

            document.getElementById("TDCompVentTotaBruto").innerHTML = ventSumaTotaBruto.toFixed(2) ;



        }
    }

    function FnAddAlmacen(obj) {
        IdTRDistribuir = obj.parentElement.parentElement.id;
        //CantDistribuir = document.getElementById("TDCant" + IdTRDistribuir).innerHTML;
        var objTxt = document.getElementById("TDCant" + IdTRDistribuir).children;
        CantDistribuir = objTxt[0].value;

        NombProdDistribuir = document.getElementById("TDNombProd" + IdTRDistribuir).innerHTML;
        var FkProd = document.getElementById("TDFkProd" + IdTRDistribuir).innerHTML;
        var options = { "backdrop": "static", keyboard: false };
        $.ajax({
            type: 'POST',
            url: '@Url.Action("ViewDistribuirCantidad", "ComprobanteVenta")',
            contentType: "application/json; charset=utf-8",
            data: "{ 'FkProd': '" + FkProd + "'}",
            datatype: "json",
            success: function (response) {
                $('#myModalContentDistCantidad').html(response);
                $('#myModalDistCantidad').modal(options);
                $('#myModalDistCantidad').modal('show');
            },
            error: function (request, status, error) {
                alert(request.responseText);
            }
        });
    }

    function FnAddNotaCredito() {
        var options = { "backdrop": "static", keyboard: false };
        CallBy = "ComprobanteVentaCreate";
        $.ajax({
            type: 'POST',
            url: '@Url.Action("ViewNotaCreditoPendientes", "NotaCredito")',
            contentType: "application/json; charset=utf-8",
            data: "{ 'CallBy': '" + CallBy + "'}",
            datatype: "json",
            success: function (response) {
                $('#myModalContentListNotaCredito').html(response);
                $('#myModalListNotaCredito').modal(options);
                $('#myModalListNotaCredito').modal('show');
            },
            error: function (request, status, error) {
                alert(request.responseText);
            }
        });
    }

    function AjaxValidaStockDisponible() {
        FnValidaStockDisponible(function (d) {
            console.log(d);
        });
    }

    function FnValidaStockDisponible(callback) {
        FnResetClassTrDetalle();
        var FkAlma = $("#cmbCompVentNew_FkAlma").val();
        var arraVali = new Array();
        var Idx = 0;
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var FkProd = "";
        var CantPedi = "";
        var pFkProd = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    FkProd = document.getElementById("TDFkProd" + newTr).innerHTML;
                    //CantPedi = document.getElementById("TDCant" + newTr).innerHTML;
                    var objTxt = document.getElementById("TDCant" + newTr).children;
                    CantPedi = objTxt[0].value;
                    arraVali[Idx] = new Array(2);
                    arraVali[Idx][0] = FkProd.trim();
                    arraVali[Idx][1] = CantPedi.trim();
                    Idx++;
                }
            }
        }
        $.ajax({
            async: false,
            type: 'POST',
            url: '@Url.Action("GetJson_ValidaStock", "ComprobanteVenta")',
            data: JSON.stringify({
                FkAlma: FkAlma, arraVali: arraVali
            }),
			contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function (response) {
                var dataLen = response.length;
                for (i = 0; i < dataLen; i++) {
                    pFkProd = response[i].fk_producto;
                    FnChangeClassNameTr(pFkProd);
                }
                if (dataLen > 0){
                    //sweetAlert("", "El alamacén no cuenta con el stock suficiente para atender la cantidad solicitada de los productos marcados", "error");
                    vgEstaVent = 2;
                } else {
                    FnLLenaTdStrDistribuir(FkAlma);
                }
                callback(vgEstaVent);
            },
            error: function (data) {
                sweetAlert("", data.responseText, "error");
            }
		});
    }

    function FnLLenaTdStrDistribuir(FkAlma) {
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var newCantPedi = "";
        var newFkProd = "";
        var newStrDist = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    //newCantPedi = document.getElementById("TDCant" + newTr).innerHTML.trim();
                    var objTxt = document.getElementById("TDCant" + newTr).children;
                    newCantPedi = objTxt[0].value;

                    newStrDist = FkAlma + "[" + newCantPedi.trim() + ",";
                    document.getElementById("TDStrDist" + newTr).innerHTML = newStrDist;
                }
            }
        }
    }

    function FnChangeClassNameTr(pFkProd) {
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var newFkProd = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    newFkProd = document.getElementById("TDFkProd" + newTr).innerHTML;
                    if (parseInt(newFkProd) == parseInt(pFkProd)) {
                        document.getElementById(newTr).className = "cssTrSinStock";
                        document.getElementById("TDHiddPorRegu" + newTr).innerHTML = "2";
                    }
                }
            }
        }
    }

    function FnAgregaClienteComprobanteVenta(FkClie, FkClietipo, DniRuc, NombRazoSoci, ClieEmai, ClieDire) {
       // debugger;
        $("#txtVentNew_DniRucClie").val(DniRuc);
        $("#txtVentNew_FkClie").val(FkClie);
        $("#txtVentNew_FkClieTipo").val(FkClietipo);
        $("#txtVentNew_NombRazoSocialClie").val(NombRazoSoci);
        $("#txtVentNew_EmailClie").val(ClieEmai);
        $("#txtVentNew_DireClie").val(ClieDire);
    }

    function FnActivaMedioPago(obj) {
        var FkMediPago = obj.value;
        var MediPagoCheq = $("#HiddCompVentNew_FkMediPagoCheq").val();
        var MediPagoDepo = $("#HiddCompVentNew_FkMediPagoDepo").val();
        var MediPagoTarj = $("#HiddCompVentNew_FkMediPagoTarj").val();
        var MediPagoNotaCred = $("#HiddCompVentNew_FkMediPagoNotaCred").val();
        if (FkMediPago == MediPagoCheq || FkMediPago == MediPagoDepo) {
            document.getElementById('lblCompVentNew_BancTarj').style.display = "";
            document.getElementById('cmbCompVentNew_FkBanco').style.display = "";
            document.getElementById('cmbCompVentNew_FkTarj').style.display = "none";
            document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').style.display = "";
            document.getElementById('txtVentNew_NroCheqVoucNotaCred').style.display = "";
            document.getElementById('btnAddNotaCred').style.display = 'none';
            $("#txtVentNew_NroCheqVoucNotaCred").val("");
            document.getElementById('lblCompVentNew_BancTarj').innerHTML = "Banco ";
            if (FkMediPago == MediPagoCheq) {
                document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').innerHTML = "Nro ";
            } else {
                document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').innerHTML = "Nro ";
            }
        } else if (FkMediPago == MediPagoTarj) {
            document.getElementById('lblCompVentNew_BancTarj').style.display = "";
            document.getElementById('cmbCompVentNew_FkBanco').style.display = "none";
            document.getElementById('cmbCompVentNew_FkTarj').style.display = "";
            document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').style.display = "none";
            document.getElementById('txtVentNew_NroCheqVoucNotaCred').style.display = "none";
            document.getElementById('btnAddNotaCred').style.display = 'none';
            $("#txtVentNew_NroCheqVoucNotaCred").val("");
            document.getElementById('lblCompVentNew_BancTarj').innerHTML = "Tipo ";
        } else if (FkMediPago == MediPagoNotaCred) {
            document.getElementById('lblCompVentNew_BancTarj').style.display = "none";
            document.getElementById('cmbCompVentNew_FkBanco').style.display = "none";
            document.getElementById('cmbCompVentNew_FkTarj').style.display = "none";
            document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').style.display = "";
            document.getElementById('txtVentNew_NroCheqVoucNotaCred').style.display = "";
            document.getElementById('btnAddNotaCred').style.display = '';
            $("#txtVentNew_NroCheqVoucNotaCred").val("");
            document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').innerHTML = "Nro ";
        } else {
            document.getElementById('lblCompVentNew_BancTarj').style.display = "none";
            document.getElementById('cmbCompVentNew_FkBanco').style.display = "none";
            document.getElementById('cmbCompVentNew_FkTarj').style.display = "none";
            document.getElementById('lblCompVentNew_NroCheqVoucNotaCred').style.display = "none";
            document.getElementById('txtVentNew_NroCheqVoucNotaCred').style.display = "none";
            document.getElementById('btnAddNotaCred').style.display = 'none';
        }
    }

    function FnGetCorrelativo() {
        var FkCompTipo = $("#cmbCompVentNew_FkCompTipo").val();
        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetJson_Correlativo_ByComprobanteTipo", "Correlativo")',
            data: JSON.stringify({
                FkCompTipo: FkCompTipo
            }),
			contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function (response) {
                var dataLen = response.length;
                $("#txtCompCompNew_NroComp").val(response.nro_correlativo);
                if (FkCompTipo == 1) {
                    document.getElementById('txtVentNew_NombRazoSocialClie').disabled = false;
                    document.getElementById('txtVentNew_DniRucClie').disabled = false;
                    document.getElementById('txtVentNew_DireClie').disabled = false;
                    document.getElementById('txtVentNew_EmailClie').disabled = false;
                } else {
                    document.getElementById('txtVentNew_NombRazoSocialClie').disabled = true;
                    document.getElementById('txtVentNew_DniRucClie').disabled = true;
                    document.getElementById('txtVentNew_DireClie').disabled = true;
                    document.getElementById('txtVentNew_EmailClie').disabled = true;
                }
            },
            error: function (data) {
                sweetAlert("", data.responseText, "error");
            }
		});
    }

    function FnGetValorDetrax() {
        debugger;
        var FkDetraxTipo = $("#cmbCompVentNew_FkDetraxTipo").val();
        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetJson_Porcentaje_ByDetraxionTipo", "ComprobanteVenta")',
            data: JSON.stringify({
                FkDetraxTipo: FkDetraxTipo
            }),
			contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function (response) {
                var dataLen = response.length;
                document.getElementById('txtCompCompNew_MontDetraccion').innerHTML = response.porcentaje;
                //$("#txtCompCompNew_MontDetraccion").val(response.porcentaje);

                var newCant = parseFloat(response.porcentaje);
                var newBruto = document.getElementById("TDCompVentTotaBrutoP").value;
                newBruto = parseFloat(newBruto);
                var newnewDetrPor = 0;
                //var newnewDetrPor = 0;
                var newTotaBruto = 0;
                //if (newCant <= 0) {
                //    //sweetAlert("", "Cantidad no válida", "error");
                //    //obj.value = obj.oldvalue;
                //}
                //else {
                    if (newBruto <= 0) {

                    } else {
                        newnewDetrPor = parseFloat(newCant) / parseFloat(100);
                        FnCalculaTotaleComprobanteVenta();
                    }

                //}

            },
            error: function (data) {
                sweetAlert("", data.responseText, "error");
            }
		});
    }

    function FnAddMedioPago() {
        //debugger;
        var opcion = $('input[name=radioMedioPago]:checked').val();
        var flgError = 0;
        if (parseInt(opcion) == 1) {
            alert("Efectivo")
        } else {
            var MediPagoEfec = $("#HiddCompVentNew_FkMediPagoEfec").val();
            var MediPagoCheq = $("#HiddCompVentNew_FkMediPagoCheq").val();
            var MediPagoDepo = $("#HiddCompVentNew_FkMediPagoDepo").val();
            var MediPagoTarj = $("#HiddCompVentNew_FkMediPagoTarj").val();
            var MediPagoLineCred = $("#HiddCompVentNew_FkMediPagoLineCred").val();
            var MediPagoNotaCred = $("#HiddCompVentNew_FkMediPagoNotaCred").val();

            var FkTipoTarj = 0;
            var FkNotaCred = 0;
            var FkBanc = 0;
            var strTipoTarj = "";
            var strBanc = "";
            var strNro = "";

            var FkMediPago = $("#cmbCompVentNew_FkMediPago").val();
            var strMediPago = document.getElementById('cmbCompVentNew_FkMediPago')[document.getElementById('cmbCompVentNew_FkMediPago').selectedIndex].innerHTML;
            var MontMedPago = $("#txtCompCompNew_MontMediPago").val();
            var SaldMediPago = 0;
            if (MontMedPago == "") {
                sweetAlert("", "MONTO NO VÁLIDO", "error");
            } else if (parseFloat(MontMedPago) <= 0) {
                sweetAlert("", "MONTO NO VÁLIDO", "error");
            } else {
                if (FkMediPago == MediPagoEfec || FkMediPago == MediPagoLineCred) { //Efectivo y Linea de credito
                    FkTipoTarj = 0;
                    FkNotaCred = 0;
                    FkBanc = 0;
                    strTipoTarj = "";
                    strBanc = "";
                    strNro = "";
                    if (FkMediPago == MediPagoLineCred) {
                        SaldMediPago = MontMedPago;
                    }
                } else if (FkMediPago == MediPagoCheq || FkMediPago == MediPagoDepo) { //Cheque y Deposito
                    FkTipoTarj = 0;
                    FkNotaCred = 0;
                    FkBanc = $("#cmbCompVentNew_FkBanco").val();
                    strTipoTarj = "";
                    strBanc = document.getElementById('cmbCompVentNew_FkBanco')[document.getElementById('cmbCompVentNew_FkBanco').selectedIndex].innerHTML;
                    strNro = $("#txtVentNew_NroCheqVoucNotaCred").val();
                    if (parseInt(FkBanc) <= 0) {
                        sweetAlert("", "SELECCIONE BANCO", "error");
                        flgError = 1;
                    } else if (strNro.trim() == "") {
                        sweetAlert("", "INGRESE NRO DE " + strMediPago, "error");
                        flgError = 1;
                    }
                } else if (FkMediPago == MediPagoTarj) { //Tarjeta
                    FkTipoTarj = $("#cmbCompVentNew_FkTarj").val();
                    FkNotaCred = 0;
                    FkBanc = 0;
                    strTipoTarj = document.getElementById('cmbCompVentNew_FkTarj')[document.getElementById('cmbCompVentNew_FkTarj').selectedIndex].innerHTML;
                    strBanc = "";
                    strNro = "";
                    if (parseInt(FkTipoTarj) <= 0) {
                        sweetAlert("", "SELECCIONE TIPO DE TARJETA", "error");
                        flgError = 1;
                    }
                } else if (FkMediPago == MediPagoNotaCred) { //Nota de Credito
                    FkTipoTarj = 0;
                    FkNotaCred = $("#txtVentNew_FkNotaCred").val();
                    FkBanc = 0;
                    strTipoTarj = "";
                    strBanc = "";
                    strNro = $("#txtVentNew_NroCheqVoucNotaCred").val();
                    if (parseInt(FkNotaCred) <= 0) {
                        sweetAlert("", "SELECCIONE NOTA DE CREDITO", "error");
                        flgError = 1;
                    }
                }
                if (flgError == 0) {
                    var IdTrMP = "IdTrMP" + NroTrMP;
                    var TDFkMediPago = "TDFkMediPago" + IdTrMP;
                    var TDFkTarj = "TDFkTarj" + IdTrMP;
                    var TDFkNotaCred = "TDFkNotaCred" + IdTrMP;
                    var TDFkBanc = "TDFkBanc" + IdTrMP;
                    var TDNroDocu = "TDNroDocu" + IdTrMP;
                    var TDMontMediPago = "TDMontMediPago" + IdTrMP;
                    var TDSaldMediPago = "TDSaldMediPago" + IdTrMP;
                    var TDBtnDeleteDeta = "TDBtnDeleteDeta" + IdTrMP;

                    var strBtnDeta= '@Html.Bootstrap().Button().Text("").Color(BootstrapColors.Default).HtmlAttributes(new { @class = "danger", @title="Eliminar Medio Pago", @onclick = "FnDeleteMedioPago(this)" }).Shiny().Size(ButtonSize.Mini).IconOnly().IconPrepend(FontAwesome.Times)';

                    var row = $("<tr id='" + IdTrMP + "'>" +
                        "<td id='" + TDFkMediPago + "' class='input-xs' style='display: none;'>" + FkMediPago + "</td>" +
                        "<td id='" + TDFkTarj + "' class='input-xs' style='display: none;'>" + FkTipoTarj + "</td>" +
                        "<td id='" + TDFkNotaCred + "' class='input-xs' style='display: none;'>" + FkNotaCred + "</td>" +
                        "<td id='" + TDFkBanc + "' class='input-xs' style='display: none;'>" + FkBanc + "</td>" +
                        "<td class='input-xs' style='text-align: center;'>" + strMediPago + "</td>" +
                        "<td class='input-xs' style='text-align: center;'>" + strTipoTarj + "</td>" +
                        "<td class='input-xs' style='text-align: center;'>" + strBanc + "</td>" +
                        "<td id='" + TDNroDocu + "' class='input-xs'>" + strNro + "</td>" +
                        "<td id='" + TDMontMediPago + "' class='input-xs' style='text-align: right;'>" + MontMedPago + "</td>" +
                        "<td id='" + TDSaldMediPago + "' class='input-xs' style='display: none;'>" + SaldMediPago + "</td>" +
                        "<td id='" + TDBtnDeleteDeta + "' class='input-xs' style='text-align: center;'>" + strBtnDeta + "</td>" +
                        "</tr>");
                    $("#tBodyMedioPago").append(row);
                    $("#txtVentNew_NroCheqVoucNotaCred").val("")
                    $("#txtCompCompNew_MontMediPago").val(0);
                    $("#txtVentNew_FkNotaCred").val(0)
                    NroTrMP++;
                }
            }

        }
    }

    function FnDeleteMedioPago(obj) {
        var IdTRsele = obj.parentElement.parentElement.id;
        var tr = $("#" + IdTRsele);
        tr.remove();
    }

    function FnGetValueRadio() {
        //debugger;
        var opcion = $('input[name=radioMedioPago]:checked').val();
        if (parseInt(opcion) == 1) {
            //document.getElementById('DivMediPago0').style.display = "";
            //document.getElementById('DivMediPago1').style.display = "";
            document.getElementById('DivMediPago2').style.display = "none";
            document.getElementById('DivMediPago3').style.display = "none";
            document.getElementById('DivMediPago4').style.display = "none";
        } else {
            //document.getElementById('DivMediPago0').style.display = "none";
            //document.getElementById('DivMediPago1').style.display = "none";
            document.getElementById('DivMediPago2').style.display = "";
            document.getElementById('DivMediPago3').style.display = "";
            document.getElementById('DivMediPago4').style.display = "";
        }
    }

    function CalculaVuelto(e) {
        if (e.keyCode == 13) {
            var MontReci = $("#txtCompCompNew_EfecReci").val();
            var MontBruto = document.getElementById('TDCompVentTotaBruto').innerHTML;
            if (parseFloat(MontReci) < parseFloat(MontBruto)) {
                sweetAlert("", "TOTAL RECIBIDO ES MENOR AL IMPORTE DE LA VENTA", "error");
            } else {
                var vuelto = (parseFloat(MontReci) - parseFloat(MontBruto)).toFixed(2);
                document.getElementById('lblVuelto').innerHTML = vuelto;
                $("#btnSaveNewCompVenta").focus();
            }
        }
    }

    function FnActivaSaveCliente() {
        vgFlgSaveNewCliente = 1;
    }
</script>
@{
    string FechEmis = DateTime.Now.ToString("dd/MM/yyyy");
    string FechVenc = DateTime.Now.ToString("dd/MM/yyyy");

    int FkClieGene = ViewBag.FkClienteGenerico;

    int FkMediPagoEfec = ViewBag.MedioPagoEfectivo;
    int FkMediPagoCheq = ViewBag.MedioPagoCheque;
    int FkMediPagoDepo = ViewBag.MedioPagoDeposito;
    int FkMediPagoTarj = ViewBag.MedioPagoTarjeta;
    int FkMediPagoNotaCred = ViewBag.MedioPagoNotaCredito;
    int FkMediPagoLineCred = ViewBag.MedioPagoLineaCredito;
    int FkCaja = ViewBag.Caja.id_caja;

    int FkAlmaPrinc = ViewBag.FkAlmacenPrincipal;
}
@Html.Hidden("HiddCompVentNew_FkClieGene", FkClieGene)
@Html.Hidden("HiddCompVentNew_FkCaja", FkCaja)
@Html.Hidden("HiddCompVentNew_FkMediPagoEfec", FkMediPagoEfec)
@Html.Hidden("HiddCompVentNew_FkMediPagoCheq", FkMediPagoCheq)
@Html.Hidden("HiddCompVentNew_FkMediPagoDepo", FkMediPagoDepo)
@Html.Hidden("HiddCompVentNew_FkMediPagoTarj", FkMediPagoTarj)
@Html.Hidden("HiddCompVentNew_FkMediPagoNotaCred", FkMediPagoNotaCred)
@Html.Hidden("HiddCompVentNew_FkMediPagoLineCred", FkMediPagoLineCred)
@Html.Hidden("sfecha_ini", "")
@Html.Hidden("sfecha_fin", "")

<div class="row">
    <div class="col-lg-12 col-sm-12 col-xs-12">
        <div class="widget">
            <div class="widget-header bordered-bottom bordered-red">
                <span class="widget-caption">Nueva Venta</span>
            </div>
            @using (var f = Html.Bootstrap().Begin(new Form().Type(FormType.Horizontal)))
            {
                <div class="widget-body">
                    <div id="horizontal-form">

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group" style="margin:0">
                                    <label class="col-sm-2 control-label" style="text-align: right;padding-top:0">Emision <sup>*</sup></label>
                                    <div class="col-md-2">
                                        @*<input data-mask="99/99/9999" class="form-control" placeholder="DD/MM/YYYY" id="txtCompCompNew_FechEmis" type="text" value="@FechEmis" readonly>*@
                                        @Html.Bootstrap().TextBox("txtCompCompNew_FechEmis").Value(@FechEmis).HtmlAttributes(new { @class = "form-control", @readonly = "readonly", @style = "border-radius: 6px !important;" }).Size(InputSize.XSmall)
                                        @*<div class='input-group'>
                <input class='form-control date-pickerIni' id='txtCompCompNew_FechEmis' type='text' data-date-format='dd/mm/yyyy' style="border-radius:6px !important; height:24px">
            </div>*@
                                    </div>
                                    <label class="col-sm-2 control-label" style="text-align: right;padding-top:0">Vencimiento <sup>*</sup></label>
                                    <div class="col-md-2">
                                        <div class='input-group'>
                                            <input class='form-control date-pickerVenc' id='txtCompCompNew_FechVenc' type='text' data-date-format='dd/mm/yyyy' style="border-radius:6px !important; height:24px">
                                        </div>
                                        @*<input data-mask="99/99/9999" class="form-control" placeholder="DD/MM/YYYY" id="txtCompCompNew_FechVenc" type="text" value="@FechVenc" style="border-radius:6px !important;height:24px !important">*@
                                        @*@Html.Bootstrap().TextBox("txtCompCompNew_FechEmis").Value(@FechEmis).HtmlAttributes(new { @class = "form-control", @readonly = "readonly", @style = "border-radius: 6px !important;" }).Size(InputSize.XSmall)*@
                                    </div>
                                    <label class="col-sm-1 control-label" style="text-align: right;padding-right:0">Moneda</label>
                                    <div class="col-md-2">
                                        @Html.Bootstrap().DropDownList("cmbCompVentNew_FkMoneda", new SelectList(ViewBag.Monedas, "IDMONEDA", "DESCRIPCION", selectedValue: 0)).HtmlAttributes(new { @autocomplete = "of", @style = "border-radius: 6px !important;width:150px" }).Size(InputSize.XSmall)
                                       
                                    </div>
                                    <div class="col-md-1">
                                        @Html.Bootstrap().TextBox("txtVentNew_TipoCambio").Placeholder("T. C.").HtmlAttributes(new { @class = "form-control", @style = "text-transform: uppercase;border-radius: 6px !important;width: 65px", @type="number", @min="0" }).Size(InputSize.XSmall)
                                    </div>
                                    </div>
                                    <div class="form-group" style="margin:0">
                                        <label class="col-sm-2 control-label" style="text-align: right;padding-top:0 ">Comprob.<sup>*</sup></label>
                                        <div class="col-md-2">
                                            @Html.Bootstrap().DropDownList("cmbCompVentNew_FkCompTipo", new SelectList(ViewBag.ComprobanteTipo, "id_comprobante_tipo", "descripcion", selectedValue: 1)).HtmlAttributes(new { @onchange = "FnGetCorrelativo()", @autocomplete = "of", @style = "border-radius: 6px !important;" }).Size(InputSize.XSmall)
                                        </div>
                                        <label class="col-sm-2 control-label" style="text-align: right;padding-top:0 ">Nro <sup>*</sup></label>
                                        <div class="col-md-2">
                                            @*<input type="text" id="txtCompCompNew_NroComp" data-mask="9999-9999999" class="form-control" placeholder="Nro Comprobante">*@
                                            @Html.Bootstrap().TextBox("txtCompCompNew_NroComp").HtmlAttributes(new { @class = "form-control", @onkeyup = "InputToUpper(this)", @style = "border-radius: 6px !important;" }).Size(InputSize.XSmall)
                                        </div>
                                        <label class="col-sm-2 control-label" style="text-align: right;">Referencia </label>
                                        <div class="col-md-2">
                                            @Html.Bootstrap().TextBox("txtVentNew_Referencia").Placeholder("Referencia / Guia").HtmlAttributes(new { @class = "form-control", @style = "text-transform: uppercase;border-radius: 6px !important;width: 165px" }).Size(InputSize.XSmall)
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0">
                                        <label class="col-sm-2 control-label" style="text-align: right; padding-top:0">Cliente </label>
                                        <div class="col-md-3">
                                            @Html.Bootstrap().TextBox("txtVentNew_DniRucClie").Placeholder("DNI / RUC").Disable().HtmlAttributes(new { @onchange = "FnActivaSaveCliente()", @style = "border-radius: 6px !important;" }).Append(new BootstrapButton("button").Id("btnAddClie").Text("").HtmlAttributes(new { @title = "Listado", @styles = "border: 0px !important;", @onclick = "FnListaCliente('CompVentaCreate')" }).IconOnly().IconPrepend(FontAwesome.ListAlt)).Size(InputSize.XSmall)
                                            @Html.Hidden("txtVentNew_FkClie", 0)
                                            @Html.Hidden("txtVentNew_FkClieTipo", 0)
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0">
                                        <label class="col-sm-2 control-label" style="text-align: right; "> </label>
                                        <div class="col-md-10">
                                            @Html.Bootstrap().TextBox("txtVentNew_NombRazoSocialClie").Placeholder("Nombres / Razón Social").HtmlAttributes(new { @class = "form-control", @style = "text-transform: uppercase;border-radius: 6px !important;", @onchange = "FnActivaSaveCliente()", @disabled = "disabled" }).Size(InputSize.XSmall)
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0; margin-top:2px">
                                        <label class="col-sm-2 control-label" style="text-align: right; "> </label>
                                        <div class="col-md-10">
                                            @Html.Bootstrap().TextBox("txtVentNew_EmailClie").Placeholder("E-mail").HtmlAttributes(new { @class = "form-control", @style = "text-transform: uppercase;border-radius: 6px !important;", @onchange = "FnActivaSaveCliente()" }).Size(InputSize.XSmall)
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0; margin-top:2px">
                                        <label class="col-sm-2 control-label" style="text-align: right; "> </label>
                                        <div class="col-md-10">
                                            @Html.Bootstrap().TextBox("txtVentNew_DireClie").Placeholder("Dirección").HtmlAttributes(new { @class = "form-control", @style = "text-transform: uppercase;border-radius: 6px !important;", @onchange = "FnActivaSaveCliente()" }).Size(InputSize.XSmall)
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0; margin-top:2px">
                                        <label class="col-sm-2 control-label" style="text-align: right; padding-top:0 ">Observaciones </label>
                                        <div class="col-md-10">
                                            @Html.Bootstrap().TextBox("txtVentNew_Observacion").Placeholder("Observacion").HtmlAttributes(new { @class = "form-control", @style = "text-transform: uppercase;border-radius: 6px !important;" }).Size(InputSize.XSmall)
                                            <div class="horizontal-space"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0; display: none;">
                                        <label class="col-sm-2 control-label" style="text-align: right; ">Almacén</label>
                                        <div class="col-md-4">
                                            @Html.Bootstrap().DropDownList("cmbCompVentNew_FkAlma", new SelectList(ViewBag.Almacen, "id_almacen", "nombre", selectedValue: FkAlmaPrinc)).HtmlAttributes(new { @onchange = "FnValidaStockDisponible()", @disabled = "disabled" }).Size(InputSize.XSmall)
                                        </div>
                                        <div class="col-md-6">
                                            @Html.Bootstrap().CheckBox("form-field-checkbox").Text("Distribuir despacho").IsChecked(false).HtmlAttributes(new { @class = "colored-default", @onchange = "FnActivaDistribucion(this)", @disabled = "disabled" })
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin:0; margin-top:2px;display:none">
                                        <label class="col-sm-12 control-label" id="lblVentNew_NombUsuaVent" style="text-align: left;">Pedido registrado por: </label>
                                        @Html.Hidden("txtVentNew_FkUsuaVent", 0)
                                    </div>
                                </div>
                            <div class="col-sm-6">
                                <div class="form-group" style="margin: 0">
                                    <label class="col-sm-3 control-label" style="text-align: right;"><u>MEDIO PAGO</u></label>
                                    @*<div class="col-md-4">
                                        @Html.Bootstrap().RadioButton("radioMedioPago", null).Text("Pendiente").HtmlAttributes(new { @class = "colored-success", @onchange = "FnGetValueRadio()", @value = 1 })
                                        <div class="horizontal-space"></div>
                                    </div>*@
                                    <div class="col-md-4">
                                        @Html.Bootstrap().RadioButton("radioMedioPago", null).Text("Otros").HtmlAttributes(new { @class = "colored-danger", @onchange = "FnGetValueRadio()", @value = 2 }).IsChecked(true)
                                        <div class="horizontal-space"></div>
                                    </div>
                                </div>
                                @*<div id="DivMediPago0" class="form-group" style="margin: 0;display:none">
                                        <label class="col-sm-3 control-label" style="text-align: right;">Efectivo Recibido </label>
                                        <div class="col-md-3">
                                            @Html.Bootstrap().TextBox("txtCompCompNew_EfecReci").HtmlAttributes(new { @class = "form-control", @type = "number", @style = "text-align: right;", @onkeypress = "CalculaVuelto(event)", @disabled = "disabled" }).Size(InputSize.XSmall)
                                        </div>
                                    </div>*@
                                @*<div id="DivMediPago1" class="form-group" style="margin: 0; display:none">
                                        <label class="col-sm-3 control-label" style="text-align: right; color: #ff0000; font-weight: bold; font-size: 1.5em;">Vuelto </label>
                                        <label class="col-sm-3 control-label" style="text-align: right; color: #ff0000; font-weight: bold; font-size: 1.5em;" id="lblVuelto">0.00 </label>
                                    </div>*@
                                <div id="DivMediPago2" class="form-group" style="margin: 0; ">
                                    <label class="col-sm-1 control-label" style="text-align: right; ">Tipo</label>
                                    <div class="col-md-4">
                                        @Html.Bootstrap().DropDownList("cmbCompVentNew_FkMediPago", new SelectList(ViewBag.MedioPago, "id_medio_pago", "descripcion", selectedValue: FkMediPagoEfec)).HtmlAttributes(new { @id = "cmbCompVentNew_FkMediPago", @onchange = "FnActivaMedioPago(this)" }).Size(InputSize.XSmall)
                                    </div>
                                    <label class="col-sm-1 control-label" id="lblCompVentNew_BancTarj" style="text-align: right; display: none;">Banco</label>
                                    <div class="col-md-3">
                                        @Html.Bootstrap().DropDownList("cmbCompVentNew_FkBanco", new SelectList(ViewBag.Banco, "id_banco", "descripcion", selectedValue: 0)).HtmlAttributes(new { @id = "cmbCompVentNew_FkBanco", style = "display: none;" }).Size(InputSize.XSmall)
                                        @Html.Bootstrap().DropDownList("cmbCompVentNew_FkTarj", new SelectList(ViewBag.TarjetaCredito, "id_tarjeta_credito", "descripcion", selectedValue: 0)).HtmlAttributes(new { @id = "cmbCompVentNew_FkTarj", style = "display: none;" }).Size(InputSize.XSmall)
                                    </div>
                                    <label class="col-sm-1 control-label" style="text-align: right;">Monto </label>
                                    <div class="col-md-2">
                                        @Html.Bootstrap().TextBox("txtCompCompNew_MontMediPago").HtmlAttributes(new { @class = "form-control", @type = "number", @style = "text-align: right;" }).Size(InputSize.XSmall)
                                    </div>
                                </div>
                                <div id="DivMediPago3" class="form-group" style="margin:0; ">
                                    <label class="col-sm-1 control-label" id="lblCompVentNew_NroCheqVoucNotaCred" style="text-align: right; display: none;"># Nota Crédito </label>
                                    <div class="col-md-4">
                                        @Html.Bootstrap().TextBox("txtVentNew_NroCheqVoucNotaCred").HtmlAttributes(new { style = "display: none; text-transform: uppercase;" }).Size(InputSize.XSmall)
                                        @Html.Hidden("txtVentNew_FkNotaCred", 0)
                                    </div>
                                    <div class="col-md-1">
                                        @Html.Bootstrap().Button().Text("").Id("btnAddNotaCred").Color(BootstrapColors.Default).IconPrepend(FontAwesome.Search).Size(ButtonSize.Mini).HtmlAttributes(new { @title = "Listado", @onclick = "FnAddNotaCredito()", @style = "margin-top: 5px; float: right; display: none;" })
                                    </div>
                                </div>
                                <div id="DivMediPago4" class="form-group" style="margin:0; ">
                                    <div class="col-md-12">
                                        @Html.Bootstrap().Button().Text("Agregar").Id("btnAddMediPago").Color(BootstrapColors.Primary).IconPrepend(FontAwesome.Download).Size(ButtonSize.Mini).HtmlAttributes(new { @title = "Listado", @onclick = "FnAddMedioPago()", @style = "margin-top: 5px; float: right;" })
                                    </div>
                                    <table class="table-striped table-hover table-bordered" id="tblMedioPago">
                                        <thead>
                                            <tr role="row">
                                                <th style="display: none;">
                                                    Fk_MEDIO_PAGO
                                                </th>
                                                <th style="display: none;">
                                                    Fk_TIPO_TARJETA
                                                </th>
                                                <th style="display: none;">
                                                    Fk_NOTA_CREDITO
                                                </th>
                                                <th style="display: none;">
                                                    Fk_BANCO
                                                </th>
                                                <th style="width: 20%; text-align: center;">
                                                    Medio Pago
                                                </th>
                                                <th style="width: 20%; text-align: center;">
                                                    Tipo Tarjeta
                                                </th>
                                                <th style="width: 20%; text-align: center;">
                                                    Banco
                                                </th>
                                                <th style="width: 20%; text-align: center;">
                                                    Nro
                                                </th>
                                                <th style="width: 15%; text-align: center;">
                                                    Monto
                                                </th>
                                                <th style="display: none;">
                                                    Saldo
                                                </th>
                                                <th style="width: 50px; text-align: center;">
                                                    ...
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tBodyMedioPago"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                @*<div class="widget-header bordered-bottom bordered-blue">
                        <span class="widget-caption">Medio de Pago y Despacho</span>
                    </div>*@
                @*<div class="widget-body">
                    <div id="horizontal-form">
                        <div class="row">

                        </div>
                        <div class="row">*@
                @*<div class="form-group" style="margin:0">
                        <label class="col-sm-1 control-label" style="text-align: right; ">Almacén</label>
                        <div class="col-md-2">
                            @Html.Bootstrap().DropDownList("cmbCompVentNew_FkAlma", new SelectList(ViewBag.Almacen, "id_almacen", "nombre")).HtmlAttributes(new { @onchange = "FnValidaStockDisponible(this)", @disabled = "disabled" }).Size(InputSize.Small)
                            <div class="horizontal-space"></div>
                        </div>
                        <div class="col-md-2">
                            @Html.Bootstrap().CheckBox("form-field-checkbox").Text("Distribuir despacho").IsChecked(false).HtmlAttributes(new { @class = "colored-default", @onchange = "FnActivaDistribucion(this)", @disabled = "disabled" })
                            <div class="horizontal-space"></div>
                        </div>
                        <label class="col-sm-4 control-label" id="lblVentNew_NombUsuaVent" style="text-align: right; ">Pedido registrado por: </label>
                        @Html.Hidden("txtVentNew_FkUsuaVent", 0)
                    </div>*@
                @*</div>
                        </div>
                    </div>*@
        <div class="widget-header bordered-bottom bordered-blue">
            <span class="widget-caption">Detalles</span>
                <select id="cmbTipoProduc" style="border-radius:6px; padding:1px;margin-top:4px">
                    <option value="ZZ">SERVICIOS</option>
                    <option value="NIU">PRODUCTOS</option>
                </select>
            @*@Html.DropDownList("cmbTipoProduc", new SelectList(new List<Object> { new { value = "ZZ", text = "SERVICIOS" }, new { value = "NIU ", text = "PRODUCTOS" } }, "value", "text", 1), new { id = "cmbTipoProduc", @style }).*@
            @Html.Bootstrap().Button().Text("Agregar").Id("btnAddProd").Color(BootstrapColors.Primary).IconPrepend(FontAwesome.ShoppingCart).Size(ButtonSize.Mini).HtmlAttributes(new { @title = "Listado", @onclick = "FnListaPrecioVenta('ComprobanteVentaCreate')", @style = "margin-top: -5px;margin-right: 50px" })
        </div>
                <div class="widget-body">
                    <div id="horizontal-form">
                        <div class="horizontal-space"></div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="table-scrollable" style="height: 200px; overflow: scroll">
                                    <table class="table table-striped table-hover table-bordered" id="tblVentDetalle">
                                        <thead>
                                            <tr role="row">
                                                <th style="display: none;">
                                                    Fk_producto
                                                </th>
                                                <th id="THBtnAddAlma" style="text-align: center; display: none;">
                                                    Despachar de
                                                </th>
                                                <th style="text-align: center;width: 150px">
                                                    Código
                                                </th>
                                                <th style="text-align: center;width: 100px">
                                                    Cod. Sunat
                                                </th>
                                                <th style="display: none;">
                                                    Distribuir
                                                </th>
                                                <th style="display: none;">
                                                    FK EMPRESA
                                                </th>
                                                <th>
                                                    Servicio / Bien
                                                </th>
                                                <th style="width:100px;text-align:center">
                                                    Afectacion
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Cantidad
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Precio
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Valor Venta
                                                </th>
                                                <th style="width: 70px; text-align: right;">
                                                    IGV
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Importe
                                                </th>
                                                <th style="width: 50px; text-align: center;">
                                                    ...
                                                </th>
                                                <th style="display: none;">
                                                    FK_TIPO_AFECTACION_IGV
                                                </th>
                                                <th style="display: none;">
                                                    FLG_AFECTO_IGV
                                                </th>
                                                <th style="display: none;">
                                                    PORCENTAJE_IGV
                                                </th>
                                                <th style="display: none;">
                                                    PRECIO_UNIDAD
                                                </th>
                                                <th style="display: none;">
                                                    PRECIO_MAYOR
                                                </th>
                                                <th style="display: none;">
                                                    TIPO INA
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tBodyVentDetalle"></tbody>
                                    </table>
                                </div>


                                <table class="table table-striped table-hover table-bordered" id="tblCompVentaTotalTITLE">
                                    <thead>
                                        <tr role="row">
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                EXONERADA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                INAFECTA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                GRAVADA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                IGV
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                GRATUITA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                TOTAL
                                            </td>
                                        </tr>
                                    </thead>
                                </table>
                                <table class="table table-striped table-hover table-bordered" id="tblCompVentaTotal">
                                    <thead>
                                        <tr role="row">
                                            <td id="TDCompVentTotaExo" style="font-weight: bold; text-align: center;width:16.6%">0.00</td>
                                            <td id="TDCompVentTotaIna" style="font-weight: bold; text-align: center;width:16.6%">0.00</td>
                                            <td id="TDCompVentTotaNeto" style="font-weight: bold; text-align: center;width:16.6%">0.00</td>
                                            <td id="TDCompVentTotaIgv" style="font-weight: bold; text-align: center;width:16.6%">0.00</td>
                                            <td id="TDCompVentTotaGra" style="font-weight: bold; text-align: center;width:16.6%">0.00</td>
                                            <td id="TDCompVentTotaBrutoP" style="font-weight: bold; text-align: center;width:16.6%">0.00</td>
                                        </tr>
                                    </thead>
                                </table>
                                <table class="table table-striped table-hover table-bordered" id="tblCompVentaDetracTotal">
                                    <thead>
                                        <tr role="row">
                                            <td style="text-align: right; font-weight: bold;">
                                                DETRACCION
                                                @Html.Bootstrap().DropDownList("cmbCompVentNew_FkDetraxTipo", new SelectList(ViewBag.DetraccionesTipo, "id_detraccion_tipo", "detraccion_tipo", selectedValue: 0)).HtmlAttributes(new { @onchange = "FnGetValorDetrax()", @autocomplete = "of", @style = "border-radius: 6px !important;" }).Size(InputSize.XSmall)
                                            </td>
                                            <td id="txtCompCompNew_MontDetraccion" style="width: 100px; font-weight: bold; text-align: right;">
                                                0.00
                                            </td>
                                            <td id="TDCompVentTotaDetra" style="width: 70px; font-weight: bold; text-align: right;">0.00</td>
                                            <td id="TDCompVentTotaBruto" style="width: 100px; font-weight: bold; text-align: right;">0.00</td>
                                            <td style="width: 50px; font-weight: bold; text-align: right;"></td>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                        <div class="horizontal-space"></div>
                        <div class="row">
                            <div class="col-md-5" style="text-align:right;vertical-align:middle;width:45%">
                                @Html.Bootstrap().Button().Text("Guardar").Id("btnSaveNewCompVenta").Color(BootstrapColors.Blue).Shiny().HtmlAttributes(new { @onclick = "FnGuardarCompVenta()" })
                            </div>
                            <div class="col-md-2" style="text-align:center;vertical-align:middle;width:10%">
                                @Html.Bootstrap().Button().Text("Previsualizar").Id("btnSaveNewCompVentaTemp").Color(BootstrapColors.Warning).Shiny().HtmlAttributes(new { @onclick = "FnGuardarCompVentaTemp()" })
                            </div>
                            <div class="col-md-5" style="text-align:left;vertical-align:middle;width:45%">
                                <button class="btn bg-blue shiny" type="button" id="btnCancel" data-dismiss="modal">Cancelar</button>
                            </div>
                        </div>

                    </div>
                </div>
            }
        </div>
    </div>
</div>
<div id="spinnerCompVentCreate" class="loading">
    <img src="~/img/spinner2.gif" alt="Loading" />
</div>
<script src="~/Scripts/UserFunction.js"></script>
<script type="text/javascript">
    var tipobientotal = "";
    var arrVentDeta = new Array();
    var arrCompVentMediPago = new Array();
    $(document).ready(function () {
        $("#spinnerCompVentCreate").hide();
        //Inicia();
        $('#spinnerCompVentCreate').bind("ajaxSend", function () {
            $(this).show();
        }).bind("ajaxComplete", function () {
            $(this).hide();
        });
        $('#loading').hide().ajaxStart(function () {
            $(this).show();
        }).ajaxStop(function () {
            $(this).hide();
        });
    });
    function FnGuardarCompVentaTemp() {
        var Observacion = $("#txtVentNew_Observacion").val();
        var FkUsuaVent = $("#txtVentNew_FkUsuaVent").val();
        var FkClie = $("#txtVentNew_FkClie").val();
        var FkClieTipo = $("#txtVentNew_FkClieTipo").val();
        var ClieDni = $("#txtVentNew_DniRucClie").val();
        var ClieNomb = $("#txtVentNew_NombRazoSocialClie").val();
        var ClieDire = $("#txtVentNew_DireClie").val();
        var ClieEmail = $("#txtVentNew_EmailClie").val();
        var FkPedi = $("#txtVentNew_FkPedi").val();
        var FkClieGene = $("#HiddCompVentNew_FkClieGene").val();
        //Del comprobante de venta
        var FkCompTipo = $("#cmbCompVentNew_FkCompTipo").val();
        var FkCaja = $("#HiddCompVentNew_FkCaja").val();
        var FkMediPago = 0;
        var FechEmis = $("#txtCompCompNew_FechEmis").val();
        var FechInic = $("#sfecha_ini").val();
        var FechVenc = $("#sfecha_fin").val();
        var NroCompVent = $("#txtCompCompNew_NroComp").val();
        var CantTrs = document.getElementById("tBodyVentDetalle").rows.length;
        var CVTotaNeto = parseFloat(document.getElementById("TDCompVentTotaNeto").innerHTML);
        var CVTotaIgv = parseFloat(document.getElementById("TDCompVentTotaIgv").innerHTML);
        var CVTotaBrut = parseFloat(document.getElementById("TDCompVentTotaBrutoP").innerHTML);
        var CVTotaExonerado = parseFloat(document.getElementById("TDCompVentTotaExo").innerHTML);
        var CVTotaInafecto = parseFloat(document.getElementById("TDCompVentTotaIna").innerHTML);
        var CVTotaGratuito = parseFloat(document.getElementById("TDCompVentTotaGra").innerHTML);

        var CVSaldBrut = 0;
        var flgChkDist = document.getElementById("form-field-checkbox").checked;
        var FkAlma = $("#cmbCompVentNew_FkAlma").val();
        //Medio de Pago
        var MediPagoLineCred = $("#HiddCompVentNew_FkMediPagoLineCred").val();
        var optMediPago = $('input[name=radioMedioPago]:checked').val();
        var sumaMediPago = 0;
        var NroPrint = 1;

        //PARA EL VUELTO
        var EfecReci = $("#txtCompCompNew_EfecReci").val();
        var Vuel     = "0";
        var CVTotalDetrax = parseFloat(document.getElementById("TDCompVentTotaDetra").innerHTML);
        var CVPorcDetrax = parseFloat(document.getElementById("txtCompCompNew_MontDetraccion").innerHTML);
        var FkCompTipoDetrax = $("#cmbCompVentNew_FkDetraxTipo").val();
        var FkCompMoneda = $("#cmbCompVentNew_FkMoneda").val();
        var tipocambio = $("#txtVentNew_TipoCambio").val();
        if (FkCompMoneda.trim() != "01" && tipocambio.trim() ==="") {
            sweetAlert("", "Debe ingresar tipo de cambio correcto", "error");
            return false;
        }
        if (FkCompMoneda.trim() != "01" && tipocambio.trim() != "") {
            tipocambio = parseFloat(tipocambio.trim());
            if (tipocambio < 1) {
                sweetAlert("", "Debe ingresar tipo de cambio correcto", "error");
                return false;
            }
        }
        if (FkCompMoneda.trim() === "01" && tipocambio.trim() === "") {
            tipocambio = 0;
        }

        var TxtReferencia = $("#txtVentNew_Referencia").val();

        debugger;
        //Preguntamos si ha selecciones solo efectivo u otros medios de pago
        if (parseInt(optMediPago) == 1) {
            arrCompVentMediPago = [];
            arrCompVentMediPago[0] = new Array(5);
            FkMediPago = $("#HiddCompVentNew_FkMediPagoEfec").val();
            sumaMediPago = CVTotaBrut;
        } else {
            arrCompVentMediPago = [];
            var IndArr = 0;
            var table = document.getElementById('tBodyMedioPago');
            var cantRows = table.rows.length;
            var newTr = "";
            var tFkMedPago = "";
            var tFkTarjCred = "";
            var tFkNotaCred = "";
            var tFkBanc = 0;
            var tNroDocu = "";
            var tMont = 0;
            var tSald = 0;
            if (cantRows > 0) {
                for (var i = 0; i < cantRows; i++) {
                    newTr = table.rows[i].id;
                    if (newTr.trim() != "") {
                        tFkMedPago = document.getElementById("TDFkMediPago" + newTr).innerHTML;
                        tFkTarjCred = document.getElementById("TDFkTarj" + newTr).innerHTML;
                        tFkNotaCred = document.getElementById("TDFkNotaCred" + newTr).innerHTML;
                        tFkBanc = document.getElementById("TDFkBanc" + newTr).innerHTML;
                        tNroDocu = document.getElementById("TDNroDocu" + newTr).innerHTML;
                        tMont = document.getElementById("TDMontMediPago" + newTr).innerHTML;
                        tSald = document.getElementById("TDSaldMediPago" + newTr).innerHTML;
                        sumaMediPago = parseFloat(sumaMediPago) + parseFloat(tMont);
                        arrCompVentMediPago[IndArr] = new Array(5);
                        arrCompVentMediPago[IndArr][0] = tFkMedPago.trim();
                        arrCompVentMediPago[IndArr][1] = tFkTarjCred.trim();
                        arrCompVentMediPago[IndArr][2] = tFkNotaCred.trim();
                        arrCompVentMediPago[IndArr][3] = tFkBanc.trim();
                        arrCompVentMediPago[IndArr][4] = tNroDocu.trim();
                        arrCompVentMediPago[IndArr][5] = tMont.trim();
                        arrCompVentMediPago[IndArr][6] = tSald.trim();
                        if (parseInt(tFkMedPago) == parseInt(MediPagoLineCred)) {
                            NroPrint = 1;
                        }
                        IndArr++;
                    }
                }
            }
        }

        var flgErrorDist = 0;
        FnLlenaArrayVentaDetalle()
        var flgError = 0;
        if (CantTrs == 0) {
            sweetAlert("", "No existen detalles para el comprobante", "error");
            flgError = 1;
        } else if (parseInt(FkCompTipo) == 0) {
            sweetAlert("", "Seleccione Tipo de Comprobante", "error");
            flgError = 1;
        } else if (NroCompVent.trim() == "") {
            sweetAlert("", "Ingrese Nro del Comprobante", "error");
            flgError = 1;
        } else if (FechEmis.trim() == "") {
            sweetAlert("", "Ingrese fecha de emisión", "error");
            flgError = 1;
        } else if (FechVenc.trim() == "") {
            sweetAlert("", "Ingrese fecha de vencimiento", "error");
            flgError = 1;
        } else if (parseInt(FkCompTipo) == 2 && parseInt(FkClieTipo) == 1) {
            sweetAlert("", "El Tipo de comprobante, no es válido para el tipo de cliente seleccionado", "error");
            flgError = 1;
        } else if (parseInt(FkPedi) == 0) {
            sweetAlert("", "Seleccione Pedido", "error");
            flgError = 1;
        } else if (parseFloat(sumaMediPago) != CVTotaBrut) {
            sweetAlert("", "Total cobrado no coincide con el importe de la venta", "error");
            flgError = 1;
        }

        if (flgError == 0) {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("SaveNewComprobanteVentaTemp", "ComprobanteVenta")',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    FkUsuaVent: 0, FkClie: FkClie, FkPedi: 0, FkCompTipo: FkCompTipo, FkCaja: FkCaja,
                    FechEmis: FechEmis, NroCompVent: NroCompVent, CVTotaNeto: CVTotaNeto, CVTotaIgv: CVTotaIgv,
                    CVTotaBrut: CVTotaBrut, EstaVent: vgEstaVent, FkAlma: FkAlma, FlgSaveNewCliente: vgFlgSaveNewCliente,
                    ClieDni: ClieDni, ClieNomb: ClieNomb, ClieDire: ClieDire, ClieEmail: ClieEmail, arrVentDeta: arrVentDeta,
                    arrCompVentMediPago: arrCompVentMediPago, arraCVIdPedi: arraCVIdPedi, EfecReci: EfecReci, Vuel: Vuel, detraccion: CVTotalDetrax, FkDetraccion: FkCompTipoDetrax, PorcDetrax: CVPorcDetrax, FkMoneda: FkCompMoneda,
                    FechVenc: FechVenc, TxtReferencia: TxtReferencia, Observacion: Observacion, TotalExonerado: CVTotaExonerado, TotalInafecto: CVTotaInafecto, TotalGratuito: CVTotaGratuito, TipoCambio: tipocambio
                }),
                dataType: 'json',
                beforeSend: function () {
                    $('#spinnerCompVentCreate').show();
                },
                traditional: true,
                success: function (data) {
                    if (parseInt(data.IdNewVent) == -1) {
                        sweetAlert("", data.msgRpta, "error");
                    }
                    else {
                        for (var j = 0; j < NroPrint; j++) {
                            FnPrinterComprobanteVentaTemp(data.IdNewVent, data.IdCompVent, data.DataQr);
                        }
                        //location.reload();
                    }
                },
                error: function (data) {
                    sweetAlert("", data.responseText, "error");
                },
                complete: function () {
                    if ($('#spinnerCompVentCreate').length > 0) {
                        $('#spinnerCompVentCreate').hide();
                    }
                }
            });
        }
    }

    function FnGuardarCompVenta() {
        var Observacion = $("#txtVentNew_Observacion").val();
        var FkUsuaVent = $("#txtVentNew_FkUsuaVent").val();
        var FkClie = $("#txtVentNew_FkClie").val();
        var FkClieTipo = $("#txtVentNew_FkClieTipo").val();
        var ClieDni = $("#txtVentNew_DniRucClie").val();
        var ClieNomb = $("#txtVentNew_NombRazoSocialClie").val();
        var ClieDire = $("#txtVentNew_DireClie").val();
        var ClieEmail = $("#txtVentNew_EmailClie").val();
        var FkPedi = $("#txtVentNew_FkPedi").val();
        var FkClieGene = $("#HiddCompVentNew_FkClieGene").val();
        //Del comprobante de venta
        var FkCompTipo = $("#cmbCompVentNew_FkCompTipo").val();
        var FkCaja = $("#HiddCompVentNew_FkCaja").val();
        var FkMediPago = 0;
        var FechEmis = $("#txtCompCompNew_FechEmis").val();
        var FechInic = $("#sfecha_ini").val();
        var FechVenc = $("#sfecha_fin").val();
        var NroCompVent = $("#txtCompCompNew_NroComp").val();
        var CantTrs = document.getElementById("tBodyVentDetalle").rows.length;
        var CVTotaNeto = parseFloat(document.getElementById("TDCompVentTotaNeto").innerHTML);
        var CVTotaIgv = parseFloat(document.getElementById("TDCompVentTotaIgv").innerHTML);
        var CVTotaBrut = parseFloat(document.getElementById("TDCompVentTotaBrutoP").innerHTML);
        var CVTotaExonerado = parseFloat(document.getElementById("TDCompVentTotaExo").innerHTML);
        var CVTotaInafecto = parseFloat(document.getElementById("TDCompVentTotaIna").innerHTML);
        var CVTotaGratuito = parseFloat(document.getElementById("TDCompVentTotaGra").innerHTML);

        var CVSaldBrut = 0;
        var flgChkDist = document.getElementById("form-field-checkbox").checked;
        var FkAlma = $("#cmbCompVentNew_FkAlma").val();
        //Medio de Pago
        var MediPagoLineCred = $("#HiddCompVentNew_FkMediPagoLineCred").val();
        var optMediPago = $('input[name=radioMedioPago]:checked').val();
        var sumaMediPago = 0;
        var NroPrint = 1;

        //PARA EL VUELTO
        var EfecReci = $("#txtCompCompNew_EfecReci").val();
        var Vuel     = "0";
        var CVTotalDetrax = parseFloat(document.getElementById("TDCompVentTotaDetra").innerHTML);
        var CVPorcDetrax = parseFloat(document.getElementById("txtCompCompNew_MontDetraccion").innerHTML);
        var FkCompTipoDetrax = $("#cmbCompVentNew_FkDetraxTipo").val();
        var FkCompMoneda = $("#cmbCompVentNew_FkMoneda").val();
        var tipocambio = $("#txtVentNew_TipoCambio").val();
        if (FkCompMoneda.trim() != "01" && tipocambio.trim() ==="") {
            sweetAlert("", "Debe ingresar tipo de cambio correcto", "error");
            return false;
        }
        if (FkCompMoneda.trim() != "01" && tipocambio.trim() != "") {
            tipocambio = parseFloat(tipocambio.trim());
            if (tipocambio < 1) {
                sweetAlert("", "Debe ingresar tipo de cambio correcto", "error");
                return false;
            }
        }
        if (FkCompMoneda.trim() === "01" && tipocambio.trim() === "") {
            tipocambio = 0;
        }

        var TxtReferencia = $("#txtVentNew_Referencia").val();

        debugger;
        //Preguntamos si ha selecciones solo efectivo u otros medios de pago
        if (parseInt(optMediPago) == 1) {
            arrCompVentMediPago = [];
            arrCompVentMediPago[0] = new Array(5);
            FkMediPago = $("#HiddCompVentNew_FkMediPagoEfec").val();
            sumaMediPago = CVTotaBrut;
        } else {
            arrCompVentMediPago = [];
            var IndArr = 0;
            var table = document.getElementById('tBodyMedioPago');
            var cantRows = table.rows.length;
            var newTr = "";
            var tFkMedPago = "";
            var tFkTarjCred = "";
            var tFkNotaCred = "";
            var tFkBanc = 0;
            var tNroDocu = "";
            var tMont = 0;
            var tSald = 0;
            if (cantRows > 0) {
                for (var i = 0; i < cantRows; i++) {
                    newTr = table.rows[i].id;
                    if (newTr.trim() != "") {
                        tFkMedPago = document.getElementById("TDFkMediPago" + newTr).innerHTML;
                        tFkTarjCred = document.getElementById("TDFkTarj" + newTr).innerHTML;
                        tFkNotaCred = document.getElementById("TDFkNotaCred" + newTr).innerHTML;
                        tFkBanc = document.getElementById("TDFkBanc" + newTr).innerHTML;
                        tNroDocu = document.getElementById("TDNroDocu" + newTr).innerHTML;
                        tMont = document.getElementById("TDMontMediPago" + newTr).innerHTML;
                        tSald = document.getElementById("TDSaldMediPago" + newTr).innerHTML;
                        sumaMediPago = parseFloat(sumaMediPago) + parseFloat(tMont);
                        arrCompVentMediPago[IndArr] = new Array(5);
                        arrCompVentMediPago[IndArr][0] = tFkMedPago.trim();
                        arrCompVentMediPago[IndArr][1] = tFkTarjCred.trim();
                        arrCompVentMediPago[IndArr][2] = tFkNotaCred.trim();
                        arrCompVentMediPago[IndArr][3] = tFkBanc.trim();
                        arrCompVentMediPago[IndArr][4] = tNroDocu.trim();
                        arrCompVentMediPago[IndArr][5] = tMont.trim();
                        arrCompVentMediPago[IndArr][6] = tSald.trim();
                        if (parseInt(tFkMedPago) == parseInt(MediPagoLineCred)) {
                            NroPrint = 1;
                        }
                        IndArr++;
                    }
                }
            }
        }

        var flgErrorDist = 0;
        FnLlenaArrayVentaDetalle()
        var flgError = 0;
        if (CantTrs == 0) {
            sweetAlert("", "No existen detalles para el comprobante", "error");
            flgError = 1;
        } else if (parseInt(FkCompTipo) == 0) {
            sweetAlert("", "Seleccione Tipo de Comprobante", "error");
            flgError = 1;
        } else if (NroCompVent.trim() == "") {
            sweetAlert("", "Ingrese Nro del Comprobante", "error");
            flgError = 1;
        } else if (FechEmis.trim() == "") {
            sweetAlert("", "Ingrese fecha de emisión", "error");
            flgError = 1;
        } else if (FechVenc.trim() == "") {
            sweetAlert("", "Ingrese fecha de vencimiento", "error");
            flgError = 1;
        } else if (parseInt(FkCompTipo) == 2 && parseInt(FkClieTipo) == 1) {
            sweetAlert("", "El Tipo de comprobante, no es válido para el tipo de cliente seleccionado", "error");
            flgError = 1;
        } else if (parseInt(FkPedi) == 0) {
            sweetAlert("", "Seleccione Pedido", "error");
            flgError = 1;
        } else if (parseFloat(sumaMediPago) != CVTotaBrut) {
            sweetAlert("", "Total cobrado no coincide con el importe de la venta", "error");
            flgError = 1;
        }

        if (flgError == 0) {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("SaveNewComprobanteVenta", "ComprobanteVenta")',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    FkUsuaVent: 0, FkClie: FkClie, FkPedi: 0, FkCompTipo: FkCompTipo, FkCaja: FkCaja,
                    FechEmis: FechEmis, NroCompVent: NroCompVent, CVTotaNeto: CVTotaNeto, CVTotaIgv: CVTotaIgv,
                    CVTotaBrut: CVTotaBrut, EstaVent: vgEstaVent, FkAlma: FkAlma, FlgSaveNewCliente: vgFlgSaveNewCliente,
                    ClieDni: ClieDni, ClieNomb: ClieNomb, ClieDire: ClieDire, ClieEmail: ClieEmail, arrVentDeta: arrVentDeta,
                    arrCompVentMediPago: arrCompVentMediPago, arraCVIdPedi: arraCVIdPedi, EfecReci: EfecReci, Vuel: Vuel, detraccion: CVTotalDetrax, FkDetraccion: FkCompTipoDetrax, PorcDetrax: CVPorcDetrax, FkMoneda: FkCompMoneda,
                    FechVenc: FechVenc, TxtReferencia: TxtReferencia, Observacion: Observacion, TotalExonerado: CVTotaExonerado, TotalInafecto: CVTotaInafecto, TotalGratuito: CVTotaGratuito, TipoCambio: tipocambio
                }),
                dataType: 'json',
                beforeSend: function () {
                    $('#spinnerCompVentCreate').show();
                },
                traditional: true,
                success: function (data) {
                    if (parseInt(data.IdNewVent) == -1) {
                        sweetAlert("", data.msgRpta, "error");
                    }
                    else {
                        for (var j = 0; j < NroPrint; j++) {
                            FnPrinterComprobanteVenta(data.IdNewVent, data.IdCompVent, data.DataQr);
                        }
                        location.reload();
                    }
                },
                error: function (data) {
                    sweetAlert("", data.responseText, "error");
                },
                complete: function () {
                    if ($('#spinnerCompVentCreate').length > 0) {
                        $('#spinnerCompVentCreate').hide();
                    }
                }
            });
        }
    }

    function FnPrinterComprobanteVentaTemp(FkVent, FkCompVent, DataQr) {
        debugger;
        DescTipoComp = document.getElementById('cmbCompVentNew_FkCompTipo')[document.getElementById('cmbCompVentNew_FkCompTipo').selectedIndex].innerHTML;
        NroCompVent = $("#txtCompCompNew_NroComp").val();
        DniRuc = $("#txtVentNew_DniRucClie").val();
        NombClie = $("#txtVentNew_NombRazoSocialClie").val();
        DireClie = $("#txtVentNew_DireClie").val();
        EfecReci = $("#txtCompCompNew_EfecReci").val();
        Vuel = '0';
        var url = '@Url.Action("PrintComprobanteVentaViewTemp", "ComprobanteVenta")?FkVent=' + FkVent +
            '&FkCompVent=' + FkCompVent + '&DescTipoComp=' + DescTipoComp + '&NroCompVent=' + NroCompVent + '&DniRuc=' + DniRuc +
            '&NombClie=' + NombClie + '&DireClie=' + DireClie + '&EfecReci=' + EfecReci + '&Vuel=' + Vuel + '&DataQr=' + DataQr;

        window.open(url, "_blank")
    }
    function FnPrinterComprobanteVenta(FkVent, FkCompVent, DataQr) {
        DescTipoComp = document.getElementById('cmbCompVentNew_FkCompTipo')[document.getElementById('cmbCompVentNew_FkCompTipo').selectedIndex].innerHTML;
        NroCompVent = $("#txtCompCompNew_NroComp").val();
        DniRuc = $("#txtVentNew_DniRucClie").val();
        NombClie = $("#txtVentNew_NombRazoSocialClie").val();
        DireClie = $("#txtVentNew_DireClie").val();
        EfecReci = $("#txtCompCompNew_EfecReci").val();
        Vuel = '0';
        var url = '@Url.Action("PrintComprobanteVentaView", "ComprobanteVenta")?FkVent=' + FkVent +
            '&FkCompVent=' + FkCompVent + '&DescTipoComp=' + DescTipoComp + '&NroCompVent=' + NroCompVent + '&DniRuc=' + DniRuc +
            '&NombClie=' + NombClie + '&DireClie=' + DireClie + '&EfecReci=' + EfecReci + '&Vuel=' + Vuel + '&DataQr=' + DataQr;

        window.open(url, "_blank")
    }
    function FnResetAlmacen() {
        //$('#cmbCompVentNew_FkAlma').get(0).selectedIndex = 0;
        $('#cmbCompVentNew_FkAlma').prop('disabled', false);
        $('#form-field-checkbox').prop('disabled', false);
        $('#form-field-checkbox').prop('checked', false);
    }

    function FnActivaDistribucion(obj) {
        var strDisplay=""
        if (obj.checked == false) {
            strDisplay = "none";
            FnResetClassTrDetalle(strDisplay);
            FnTrDisplayDetalle("none");
            $('#cmbCompVentNew_FkAlma').get(0).selectedIndex = 0;
            $('#cmbCompVentNew_FkAlma').prop('disabled', false);
        }
        else {
            FnTrDisplayDetalle(strDisplay);
            $('#cmbCompVentNew_FkAlma').get(0).selectedIndex = 0;
            $('#cmbCompVentNew_FkAlma').prop('disabled', true);
        }
    }

    function FnLlenaArrayVentaDetalle() {
        debugger;
        arrVentDeta = [];
        var IndArr = 0;
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var FkProd = "";
        var CodProd = "";
        var Cant = "";
        var Prec = "";
        var Neto = "";
        var Igv = "";
        var Importe = "";
        var FkTipoAfecIGV = 0;
        var StrDisp = "";
        var PorRegu = "";
        var CodSunat = "";
        var DescripPro = "";
        var TipoBienItem = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    objTxtc = document.getElementById("TDCodSunat" + newTr).children;
                    CodSunat = objTxtc[0].value;
                    objTxtd = document.getElementById("TDNombProd" + newTr).children;
                    DescripPro = objTxtd[0].value;
                    FkProd = document.getElementById("TDFkProd" + newTr).innerHTML;
                    CodProd = document.getElementById("TDCodiProd" + newTr).innerHTML;
                    //Cant = document.getElementById("TDCant" + newTr).innerHTML;
                    var objTxt = document.getElementById("TDCant" + newTr).children;
                    Cant = objTxt[0].value;
                    //Prec = document.getElementById("TDPrec" + newTr).innerHTML;
                    objTxt = document.getElementById("TDPrec" + newTr).children;
                    Prec = objTxt[0].value;
                    FkTipoAfecIGV = document.getElementById("TDFkTipoAfecIgv" + newTr).innerHTML;

                    Neto = document.getElementById("TDTotaNeto" + newTr).innerHTML;
                    Igv = document.getElementById("TDTotaIgv" + newTr).innerHTML;
                    Importe = document.getElementById("TDTotaBruto" + newTr).innerHTML;

                    TipoBienItem = document.getElementById("TDHiddTipoBien" + newTr).innerHTML;

                    StrDisp = document.getElementById("TDStrDist" + newTr).innerHTML.trim();
                    if (StrDisp != "") {
                        StrDisp = StrDisp.substring(0, StrDisp.length - 1);
                    }
                    PorRegu = document.getElementById("TDHiddPorRegu" + newTr).innerHTML.trim();
                    arrVentDeta[IndArr] = new Array(6);
                    arrVentDeta[IndArr][0] = FkProd.trim();
                    arrVentDeta[IndArr][1] = Cant.trim();
                    arrVentDeta[IndArr][2] = Prec.trim();
                    arrVentDeta[IndArr][3] = FkTipoAfecIGV.trim();
                    arrVentDeta[IndArr][4] = StrDisp.trim();
                    arrVentDeta[IndArr][5] = PorRegu.trim();
                    arrVentDeta[IndArr][6] = CodSunat.trim();
                    arrVentDeta[IndArr][7] = CodProd.trim();
                    arrVentDeta[IndArr][8] = DescripPro.trim();

                    arrVentDeta[IndArr][9] = Neto.trim();
                    arrVentDeta[IndArr][10] = Igv.trim();
                    arrVentDeta[IndArr][11] = Importe.trim();
                    arrVentDeta[IndArr][12] = TipoBienItem.trim();

                    IndArr++;
                }
            }
        }
    }

    function ValidaDistribucion() {
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var flgReturn = 0;
        var strDist = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    strDist = document.getElementById("TDStrDist" + newTr).innerHTML;
                    if (strDist.trim() == "") {
                        document.getElementById(newTr).className = "cssTrSinStock";
                        flgReturn = 1;
                    }
                }
            }
        }
        return flgReturn;
    }

    function FnResetClassTrDetalle() {
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                document.getElementById(newTr).className = "";
            }
        }
    }

    function FnTrDisplayDetalle(strDisplay) {
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        document.getElementById("THBtnAddAlma").style.display = strDisplay;
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                document.getElementById("TDBtnAddAlma" + newTr).style.display = strDisplay;
            }
        }
    }


</script>
<style type="text/css">
    .modal-backdrop {
        z-index: -1;
    }

    .cssTrSinStock {
        background-color: rgba(244,157,138,0.8) !important;
    }
</style>