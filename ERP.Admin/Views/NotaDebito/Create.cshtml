
@model ERP.Admin.Models.ComprobanteVenta
<script src="~/Scripts/UserFunction.js"></script>
<script type="text/javascript">
    var NroTrVD = 1;
    var arrSaveIDGuiaRemi = new Array();
    var IdTRDistribuir = "";
    var CantDistribuir = 0;
    var NombProdDistribuir = "";
    var arraInitAlmaCant = new Array();
    var FkProdDistribuir = 0;
    var SiglCV = "";
    $(document).ready(function () {
        FnGetCorrelativo();
       // FnCalculTotalesIni();
    });

    function FnCalculTotalesIni() {
        var IndArr = 0;
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var FkProd = "";
        var Cant = "";
        var Prec = "";
        var Brut = 0;
        var pFlgAfecIgv = "";
        var pPorcIgv = "";
        var pTotaNeto = 0;
        var pTotaIgv = 0;
        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    //Cant = document.getElementById("TDCant" + newTr).innerHTML;
                    var objTxt = document.getElementById("TDCant" + newTr).children;
                    Cant = objTxt[0].value;
                    //Prec = document.getElementById("TDPrec" + newTr).innerHTML;
                    objTxt = document.getElementById("TDPrec" + newTr).children;
                    Prec = objTxt[0].value;
                    pFlgAfecIgv = document.getElementById("TDFlgAfecIgv" + newTr).innerHTML;
                    pPorcIgv = document.getElementById("TDPorcIgv" + newTr).innerHTML;
                    Brut = parseFloat(Cant) * parseFloat(Prec);
                    if (pFlgAfecIgv.trim() == "1") {
                        pTotaIgv = CalculaIgv(Brut, pPorcIgv);
                    }
                    pTotaNeto = (parseFloat(Brut) - parseFloat(pTotaIgv)).toFixed(2);
                    document.getElementById("TDTotaNeto" + newTr).innerHTML = pTotaNeto;
                    document.getElementById("TDTotaIgv" + newTr).innerHTML = parseFloat(pTotaIgv).toFixed(2);
                    document.getElementById("TDTotaBruto" + newTr).innerHTML = parseFloat(Brut).toFixed(2);
                }
            }
        }
    }

    function FnDeleteDetalle(obj) {
        var IdTRsele = obj.parentElement.parentElement.id;
        var tr = $("#" + IdTRsele);
        tr.remove();
        FnCalculaTotaleComprobanteVenta();
    }

    function FnValidaPrecio(obj) {
        var IdTRsele = obj.parentElement.parentElement.id;
        var newPrec = parseInt(obj.value);
        if (newPrec <= 0) {
            sweetAlert("", "Precio no válido", "error");
            obj.value = obj.oldvalue;
        } else {
            FnCalculaSubtotal(IdTRsele);
        }
    }

    function FnValidaCantidad(obj) {
        var IdTRsele = obj.parentElement.parentElement.id;
        var CantHidd = document.getElementById('TDHiddCant' + IdTRsele).innerHTML;
        var newCant = parseInt(obj.value);
        var newPrec = 0;
        if (newCant <= 0) {
            sweetAlert("", "Cantidad no válida", "error");
            obj.value = obj.oldvalue;
        }
        //else if (parseFloat(newCant) > parseFloat(CantHidd)) {
        //    sweetAlert("", "Cantidad no válida", "error");
        //    obj.value = obj.oldvalue;
        //}
        else {
            FnCalculaSubtotal(IdTRsele);
        }
    }

    function FnCalculaSubtotal(IdTRsele) {
        debugger;
        var objTxt = document.getElementById("TDCant" + IdTRsele).children;
        var newCant = objTxt[0].value;
        objTxt = document.getElementById("TDPrec" + IdTRsele).children;
        var newPrec = objTxt[0].value;

        var newFlgAfecIgv = "";
        var newTotaBruto = 0;
        var newTotaNeto = 0;
        var newTotaIgv = 0;
        var newPorcIgv = 0;

        newPorcIgv = document.getElementById("TDPorcIgv" + IdTRsele).innerHTML;
        newTotaBruto = (parseFloat(newCant) * parseFloat(newPrec)).toFixed(2);
        var tempigv = CalculaIgvMas(newTotaBruto, newPorcIgv);
        newTotaBruto = parseFloat(newTotaBruto) + parseFloat(tempigv);

        newFlgAfecIgv = document.getElementById("TDFlgAfecIgv" + IdTRsele).innerHTML;
        if (newFlgAfecIgv.trim() == "1") {
            //newPorcIgv = document.getElementById("TDPorcIgv" + IdTRsele).innerHTML;
            //newTotaIgv = CalculaIgv(newTotaBruto, newPorcIgv);
            newTotaIgv = CalculaIgvMas(newTotaBruto, newPorcIgv);
            newTotaIgv = tempigv;
        }
        newTotaNeto = newTotaBruto - newTotaIgv;

        document.getElementById("TDTotaNeto" + IdTRsele).innerHTML = parseFloat(newTotaNeto).toFixed(2);
        document.getElementById("TDTotaIgv" + IdTRsele).innerHTML = parseFloat(newTotaIgv).toFixed(2)
        document.getElementById("TDTotaBruto" + IdTRsele).innerHTML = parseFloat(newTotaBruto).toFixed(2)
        FnCalculaTotaleComprobanteVenta();
    }

    function FnCalculaTotaleComprobanteVenta() {
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var newTotaNeto = "";
        var newTotaIgv = "";
        var newTotaBruto = "";
        var ventSumaTotaNeto = 0;
        var ventSumaTotaIgv = 0;
        var ventSumaTotaBruto = 0;

        var newDetraPorc = "";
        var newTotaDetra = "";
        var ventSumaTotaBrutoP = 0;

        var tipoinao = "";
        var gratuita = 0;
        var exonerada = 0;
        var inafecta = 0;

        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    tipoinao = document.getElementById("TDHiddTipoIna" + newTr).innerHTML;
                    newTotaNeto = document.getElementById("TDTotaNeto" + newTr).innerHTML;
                    newTotaIgv = document.getElementById("TDTotaIgv" + newTr).innerHTML;
                    newTotaBruto = document.getElementById("TDTotaBruto" + newTr).innerHTML;

                    if (tipoinao === 'GRA') {
                        gratuita = parseFloat(gratuita) + parseFloat(newTotaNeto);
                    }
                    else if (tipoinao === 'EXO') {
                        exonerada = parseFloat(exonerada) + parseFloat(newTotaNeto);
                    }
                    else if (tipoinao === 'INA') {
                        inafecta = parseFloat(inafecta) + parseFloat(newTotaNeto);
                    } else {
                        ventSumaTotaNeto = parseFloat(ventSumaTotaNeto) + parseFloat(newTotaNeto);
                    }

                    ventSumaTotaIgv = parseFloat(ventSumaTotaIgv) + parseFloat(newTotaIgv);
                    ventSumaTotaBruto = parseFloat(ventSumaTotaBruto) + parseFloat(newTotaBruto);
                    //ventSumaTotaNeto = parseFloat(ventSumaTotaNeto) + parseFloat(newTotaNeto);
                    ventSumaTotaBrutoP = parseFloat(ventSumaTotaBrutoP) + parseFloat(newTotaBruto);
                }
            }
            //document.getElementById("TDCompVentTotaNeto").innerHTML = ventSumaTotaNeto.toFixed(2);
            //document.getElementById("TDCompVentTotaIgv").innerHTML = ventSumaTotaIgv.toFixed(2);
            //document.getElementById("TDCompVentTotaBruto").innerHTML = ventSumaTotaBruto.toFixed(2);

            document.getElementById("TDCompVentTotaExo").innerHTML = exonerada.toFixed(2);
            document.getElementById("TDCompVentTotaIna").innerHTML = inafecta.toFixed(2);
            document.getElementById("TDCompVentTotaGra").innerHTML = gratuita.toFixed(2);

            ventSumaTotaBruto = parseFloat(ventSumaTotaBrutoP) - parseFloat(gratuita) - parseFloat(exonerada) - parseFloat(inafecta);

            document.getElementById("TDCompVentTotaNeto").innerHTML = ventSumaTotaNeto.toFixed(2);
            document.getElementById("TDCompVentTotaIgv").innerHTML = ventSumaTotaIgv.toFixed(2);
            //document.getElementById("TDCompVentTotaBruto").innerHTML = ventSumaTotaBruto.toFixed(2);
            document.getElementById("TDCompVentTotaBrutoP").innerHTML = ventSumaTotaBruto.toFixed(2);

            //newDetraPorc = document.getElementById("txtCompCompNew_MontDetraccion").value;
            newDetraPorc = 0;

            newTotaDetra = parseFloat(ventSumaTotaBruto) * (parseFloat(newDetraPorc) / parseFloat(100));
            //document.getElementById("TDCompVentTotaDetra").innerHTML = newTotaDetra.toFixed(2);
            ventSumaTotaBruto = parseFloat(ventSumaTotaBruto) - parseFloat(newTotaDetra);
            document.getElementById("TDCompVentTotaBrutoP").innerHTML = ventSumaTotaBruto.toFixed(2);

        } else {
            document.getElementById("TDCompVentTotaExo").innerHTML = 0.00;
            document.getElementById("TDCompVentTotaIna").innerHTML = 0.00;
            document.getElementById("TDCompVentTotaGra").innerHTML = 0.00;
            document.getElementById("TDCompVentTotaNeto").innerHTML = 0.00;
            document.getElementById("TDCompVentTotaIgv").innerHTML = 0.00;
            //document.getElementById("TDCompVentTotaBruto").innerHTML = 0.00;
            document.getElementById("TDCompVentTotaBrutoP").innerHTML = 0.00;
        }
    }

    function FnGetCorrelativo() {
        debugger;
        var FkCompTipo = $("#cmbNotaDeb_FkCompTipo").val();
        SiglCV = $("#HiddNotaDeb_SiglCV").val();
        var NewNroComp = "";
        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetJson_Correlativo_ByComprobanteTipo2", "Correlativo")',
            data: JSON.stringify({
                FkCompTipo: FkCompTipo, SiglCV: SiglCV
            }),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function (response) {
                var dataLen = response.length;
                //NewNroComp = SiglCV + response.nro_correlativo.substring(1);//, response.nro_correlativo.length - 1);
                NewNroComp = response.nro_correlativo;//, response.nro_correlativo.length - 1);
                $("#txtNotaDeb_NroComp").val(NewNroComp);
            },
            error: function (data) {
                console.log("data: ", data);
                sweetAlert("", "No existe serie para este comprobante!", "error");
            }
        });
    }
</script>
@{
    string strFechEmisNC = DateTime.Now.ToString("dd/MM/yyyy");
    string strFechEmis = Convert.ToDateTime(Model.f_emision).ToString("dd/MM/yyyy");
    string CallBy = ViewBag.CallBy;
    string strTitle = "Detalle Venta";
    if (CallBy == "ComprobanteVentaRevertir")
    {
        strTitle = "Revertir Venta";
    }
    string strUsuaVenta = Model.nombre_usuario_venta + " " + Model.apellido_paterno_usuario_venta + " " + Model.apellido_materno_usuario_venta;
    string DniRuc = "";
    string NombRazoSoci = "";
    string Direccion = "";
    int FkClie = 0;
    int FkClieTipo = Model.fk_cliente_tipo;
    FkClie = Model.fk_empresa;
    DniRuc = Model.ruc_empresa_cliente_juridico;
    NombRazoSoci = Model.razon_social;
    Direccion = Model.direccion_empresa;
    //if (Model.id_cliente_juridico.Equals(0))
    //{
    //    FkClie = Model.id_cliente_natural;
    //    DniRuc = Model.dni_cliente_natural;
    //    NombRazoSoci = Model.nombre_cliente_natural + " " + Model.apellido_paterno_cliente_natural + " " + Model.apellido_materno_cliente_natural;
    //}
    //else
    //{
    //    FkClie = Model.id_cliente_juridico;
    //    DniRuc = Model.ruc_empresa_cliente_juridico;
    //    NombRazoSoci = Model.razon_social;
    //}

    //string NroNotaDeb = Model.nro_comprobante;
    //NroNotaDeb = Model.sigla + NroNotaDeb.Remove(0, 1);
}
@Html.Hidden("HiddNotaDeb_FkCompVent", Model.id_comprobante_venta)
@Html.Hidden("HiddNotaDeb_CallBy", CallBy)
@Html.Hidden("HiddNotaDeb_SiglCV", Model.sigla)
<div class="row">
    <div class="col-lg-12 col-sm-12 col-xs-12">
        <div class="widget">
            <div class="widget-header bordered-bottom bordered-red">
                <span class="widget-caption">NOTA DE CRÉDITO</span>
            </div>
            @using (var f = Html.Bootstrap().Begin(new Form().Type(FormType.Horizontal)))
            {
                <div class="widget-body">
                    <div id="horizontal-form">
                        <div class="row">
                            <div class="form-group" style="margin:0">
                                <label class="col-sm-1 control-label" style="text-align: right; ">Tipo <sup>*</sup></label>
                                <div class="col-md-2">
                                    @Html.Bootstrap().DropDownList("cmbNotaDeb_FkCompTipo", new SelectList(ViewBag.ComprobanteTipo, "id_comprobante_tipo", "descripcion", selectedValue: ViewBag.FkCompTipoNotaDebito)).HtmlAttributes(new { @disabled = "disabled", @style = "border-radius: 6px !important;" }).Size(InputSize.Small)
                                </div>
                                <label class="col-sm-1 control-label" style="text-align: right; ">Nro <sup>*</sup></label>
                                <div class="col-md-2">
                                    <input type="text" id="txtNotaDeb_NroComp" @*value="@NroNotaDeb"*@ data-mask="9999-9999999" class="form-control" placeholder="Nro Comprobante" disabled style="border-radius: 6px !important;">
                                </div>
                                <label class="col-sm-2 control-label" style="text-align: right;">Fecha Emision <sup>*</sup></label>
                                <div class="col-md-2">
                                    <input data-mask="99/99/9999" class="form-control" placeholder="DD/MM/YYYY" id="txtNotaDeb_FechEmis" value="@strFechEmisNC" type="text" style="border-radius: 6px !important;">
                                </div>
                                <div class="col-md-2" style="display: none;">
                                    @Html.Bootstrap().CheckBox("ChkNotaDeb_AfecStoc").Text("Afecta Stock").IsChecked(false).HtmlAttributes(new { @class = "colored-default" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="widget-header bordered-bottom bordered-blue">
                    <span class="widget-caption">Comprobante al que afecta</span>
                </div>
                <div class="widget-body">
                    <div id="horizontal-form">
                        <div class="row">
                            <div class="form-group" style="margin:0">
                                <label class="col-sm-1 control-label" style="text-align: right; ">Tipo</label>
                                <div class="col-md-2">
                                    @Html.Bootstrap().TextBox("txtCompVent_CompTipo").Value(Model.descripcion_comprobante_tipo).Placeholder("Tipo Comprobante").Disable().HtmlAttributes(new { @style = "border-radius: 6px !important;" }).Size(InputSize.Small)
                                </div>
                                <label class="col-sm-1 control-label" style="text-align: right; ">Nro</label>
                                <div class="col-md-2">
                                    <input type="text" id="txtCompComp_NroComp1" value="@Model.nro_comprobante" data-mask="9999-9999999" class="form-control" disabled style="border-radius:6px !important;">
                                </div>
                                <label class="col-sm-4 control-label" style="text-align: right;">Fecha Emision</label>
                                <div class="col-md-2">
                                    <input data-mask="99/99/9999" class="form-control" placeholder="DD/MM/YYYY" id="txtCompVent_FechEmis" value="@strFechEmis" type="text" disabled style="border-radius:6px !important">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group" style="margin:0">
                                <label class="col-sm-1 control-label" style="text-align: right; ">Cliente </label>
                                <div class="col-md-2">
                                    @Html.Bootstrap().TextBox("txtVentEdit_DniRucClie").Value(DniRuc).Placeholder("DNI / RUC").Disable().Size(InputSize.Small).HtmlAttributes(new { @style = "border-radius:6px !important" })
                                    @Html.Hidden("txtVentEdit_FkClie", FkClie)
                                    @Html.Hidden("txtVentEdit_FkClieTipo", FkClieTipo)
                                </div>
                                <div class="col-md-3">
                                    @Html.Bootstrap().TextBox("txtVentEdit_NombRazoSocialClie").Value(NombRazoSoci).Placeholder("Nombres / Razón Social").HtmlAttributes(new { @class = "form-control", @onkeyup = "InputToUpper(this)", @disabled = "disabled", @style = "border-radius:6px !important" }).Size(InputSize.Small)
                                </div>
                                <div class="col-md-6">
                                    @Html.Bootstrap().TextBox("txtVentEdit_DireccionClie").Value(Direccion).Placeholder("Direccion").HtmlAttributes(new { @class = "form-control", @onkeyup = "InputToUpper(this)", @disabled = "disabled", @style = "border-radius:6px !important" }).Size(InputSize.Small)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="widget-header bordered-bottom bordered-blue">
                    <span class="widget-caption">Detalles</span>
                </div>
                <div class="widget-body">
                    <div id="horizontal-form">
                        <div class="horizontal-space"></div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="table-scrollable" style="height: 200px; overflow: scroll">
                                    <table class="table table-striped table-hover table-bordered" id="tblVentDetalle">
                                        <thead>
                                            <tr role="row">
                                                <th style="display: none;">
                                                    ID_VENTA_DETALLE
                                                </th>
                                                <th style="display: none;">
                                                    Fk_producto
                                                </th>
                                                <th style="text-align: center;">
                                                    Código
                                                </th>
                                                <th style="text-align: center;">
                                                    Descripcion
                                                </th>
                                                <th style="width: 50px; text-align: center;">
                                                    Tipo IGV
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Cantidad
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Precio
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Valor Venta
                                                </th>
                                                <th style="width: 70px; text-align: right;">
                                                    IGV
                                                </th>
                                                <th style="width: 100px; text-align: right;">
                                                    Importe
                                                </th>
                                                <th style="display: none;">
                                                    FK_TIPO_AFECTACION_IGV
                                                </th>
                                                <th style="display: none;">
                                                    FLG_AFECTO_IGV
                                                </th>
                                                <th style="display: none;">
                                                    PORCENTAJE_IGV
                                                </th>
                                                <th style="width: 50px; text-align: center;">
                                                    ...
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tBodyVentDetalle">
                                            @foreach (var item in ViewBag.VentaDetalle)
                                            {
                                                var IdTrVD = "IdTrEditVD" + item.id_venta_detalle;
                                                var TDIdVentDeta = "TDIdVentDeta" + IdTrVD;
                                                var TDFkProd = "TDFkProd" + IdTrVD;
                                                var TDCodigo = "TDCodigo" + IdTrVD;
                                                var TDNombProd = "TDNombProd" + IdTrVD;
                                                var TDCant = "TDCant" + IdTrVD;
                                                var TDPrec = "TDPrec" + IdTrVD;
                                                var TDTotaNeto = "TDTotaNeto" + IdTrVD;
                                                var TDTotaIgv = "TDTotaIgv" + IdTrVD;
                                                var TDTotaBruto = "TDTotaBruto" + IdTrVD;
                                                var TDBtnDeleteDeta = "TDBtnDeleteDeta" + IdTrVD;
                                                var TDFkTipoAfecIgv = "TDFkTipoAfecIgv" + IdTrVD;
                                                var TDFlgAfecIgv = "TDFlgAfecIgv" + IdTrVD;
                                                var TDPorcIgv = "TDPorcIgv" + IdTrVD;
                                                var TDHiddCant = "TDHiddCant" + IdTrVD;
                                                var TDBtnDescAfec = "TDBtnDescAfec" + IdTrVD;
                                                var TDCodiProd = "TDCodiProd" + IdTrVD;
                                                var TDHiddTipoBien = "TDHiddTipoBien" + IdTrVD;
                                                var TDHiddCodSunat = "TDHiddCodSunat" + IdTrVD;
                                                var TDHiddIsc = "TDHiddIsc" + IdTrVD;

                                                var TDIgvSelecProd = "TDIgvSelecProd" + IdTrVD;

                                                var TDHiddTipoIna = "TDHiddTipoIna" + IdTrVD;
                                                var xporcentaje = 0;
                                                if (@item.fk_tipo_afectacion_igv == 1)
                                                {
                                                    xporcentaje = 18;
                                                }

                                                <tr id='@IdTrVD'>
                                                    <td id='@TDIdVentDeta' class='input-xs' style='display: none;'>@item.id_venta_detalle</td>
                                                    <td id="@TDFkProd" class='input-xs' style='text-align: center; display: none;'>@item.fk_proyecto</td>
                                                    <td id="@TDCodiProd" class='input-xs' style='text-align: center;'>@item.codigo</td>
                                                    <td id="@TDNombProd" class='input-xs'>@item.descripcion</td>
                                                    <td class='input-xs' style='text-align: center;vertical-align:middle;'>
                                                        @*@item.descripcion_afectacion*@
                                                        @Html.Bootstrap().DropDownList("TDIgvSelecProd", new SelectList(ViewBag.ListTipoAfectacion, "id_tipo_afectacion_igv", "descripcion", selectedValue: @item.fk_tipo_afectacion_igv)).HtmlAttributes(new { @style = "", @onchange = "FnSetTaxes(this)" }).Size(InputSize.Small)
                                                    </td>
                                                    <td id='@TDCant' class='input-xs' style='text-align: right;'>
                                                        @Html.Bootstrap().TextBox("txtCant").Value(@item.cantidad).Size(InputSize.XSmall).HtmlAttributes(new { @onchange = "FnValidaCantidad(this)", @onfocus = "this.oldvalue = this.value;", @type = "number", @min = "0", @style = "text-align: right;" })
                                                    </td>
                                                    <td id='@TDPrec' class='input-xs' style='text-align: right;'>
                                                        @Html.Bootstrap().TextBox("txtCant").Value(@item.precio).Size(InputSize.XSmall).HtmlAttributes(new { @onchange = "FnValidaPrecio(this)", @onfocus = "this.oldvalue = this.value;", @type = "number", @min = "0", @style = "text-align: right;" })
                                                    </td>
                                                    <td id='@TDTotaNeto' class='input-xs' style='text-align: right;'>@item.valor_venta</td>
                                                    <td id='@TDTotaIgv' class='input-xs' style='text-align: right;'>@item.igv</td>
                                                    <td id='@TDTotaBruto' class='input-xs' style='text-align: right;'>@item.importe</td>

                                                    <td id='@TDBtnDescAfec' class='input-xs' style='display: none; text-align: center;'>@item.descripcion_afectacion </td>
                                                    <td id='@TDFkTipoAfecIgv' class='input-xs' style='display: none;'>@item.fk_tipo_afectacion_igv</td>
                                                    <td id='@TDFlgAfecIgv' class='input-xs' style='display: none;'>@item.flag_afecto_igv</td>
                                                    <td id='@TDPorcIgv' class='input-xs' style='display: none;'>@xporcentaje</td>
                                                    <td id='@TDHiddTipoIna' class='input-xs' style='display: none;'>@item.tipoina</td>
                                                    <td id='@TDHiddCodSunat' class='input-xs' style='text-align: right; display: none;'>
                                                        @item.codigo_sunat
                                                    </td>
                                                    <td id='@TDHiddTipoBien' class='input-xs' style='text-align: right; display: none;'>
                                                        @item.tipo_bien
                                                    </td>
                                                    <td id='@TDHiddCant' class='input-xs' style='text-align: right; display: none;'>
                                                        @item.cantidad
                                                    </td>
                                                    <td id='@TDHiddIsc' class='input-xs' style='text-align: right; display: none;'>
                                                        @item.fk_tipo_isc
                                                    </td>
                                                    <td id='@TDBtnDeleteDeta' class='input-xs' style='text-align: center;'>
                                                        @Html.Bootstrap().Button().Text("").Color(BootstrapColors.Default).HtmlAttributes(new { @class = "danger", @title = "Eliminar Detalle", @onclick = "FnDeleteDetalle(this)" }).Shiny().Size(ButtonSize.Mini).IconOnly().IconPrepend(FontAwesome.Times)
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                @*<table class="table table-striped table-hover table-bordered" id="tblCompVentaTotal">
            <thead>
                <tr role="row">
                    <td style="text-align: right; font-weight: bold;">
                        TOTAL
                    </td>
                    <td id="TDCompVentTotaNeto" style="width: 100px; font-weight: bold; text-align: right;">@Model.total_neto</td>
                    <td id="TDCompVentTotaIgv" style="width: 70px; font-weight: bold; text-align: right;">@Model.total_igv</td>
                    <td id="TDCompVentTotaBruto" style="width: 100px; font-weight: bold; text-align: right;">@Model.total_bruto</td>
                    <td style="width: 50px; font-weight: bold; text-align: right;"></td>
                </tr>
            </thead>
        </table>*@
                                <table class="table table-striped table-hover table-bordered" id="tblCompVentaTotalTITLE">
                                    <thead>
                                        <tr role="row">
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                EXONERADA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                INAFECTA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                GRAVADA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                IGV
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                GRATUITA
                                            </td>
                                            <td style="text-align: center; font-weight: bold;width:16.6%">
                                                TOTAL
                                            </td>
                                        </tr>
                                    </thead>
                                </table>
                                <table class="table table-striped table-hover table-bordered" id="tblCompVentaTotal">
                                    <thead>
                                        <tr role="row">
                                            <td id="TDCompVentTotaExo" style="font-weight: bold; text-align: center;width:16.6%">@Model.total_exonerado</td>
                                            <td id="TDCompVentTotaIna" style="font-weight: bold; text-align: center;width:16.6%">@Model.total_inafecto</td>
                                            <td id="TDCompVentTotaNeto" style="font-weight: bold; text-align: center;width:16.6%">@Model.total_neto</td>
                                            <td id="TDCompVentTotaIgv" style="font-weight: bold; text-align: center;width:16.6%">@Model.total_igv</td>
                                            <td id="TDCompVentTotaGra" style="font-weight: bold; text-align: center;width:16.6%">@Model.total_gratuito</td>
                                            <td id="TDCompVentTotaBrutoP" style="font-weight: bold; text-align: center;width:16.6%">@Model.total_bruto</td>

                                            @*<td id="TDCompVentTotaNeto" style="width: 100px; font-weight: bold; text-align: right;"></td>
                    <td id="TDCompVentTotaIgv" style="width: 70px; font-weight: bold; text-align: right;"></td>
                    <td id="TDCompVentTotaBruto" style="width: 100px; font-weight: bold; text-align: right;">@Model.total_bruto</td>
                    <td style="width: 50px; font-weight: bold; text-align: right;"></td>*@
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                        <div class="horizontal-space"></div>
                        <div class="row">
                            <div class="form-group" style="margin:0">
                                <div class="col-md-4">
                                    @Html.Bootstrap().RadioButton("RadiNotaDeb_MotiNC", null).Text("INTERESES POR MORA").HtmlAttributes(new { @class = "colored-success", @value = "1", @onchange = "FnAgregaInteres()" })
                                </div>
                                <div class="col-md-4">
                                    @Html.Bootstrap().RadioButton("RadiNotaDeb_MotiNC", null).Text("AUMENTO DE VALOR").HtmlAttributes(new { @class = "colored-success", @value = "2" })
                                </div>
                                <div class="col-md-4">
                                    @Html.Bootstrap().RadioButton("RadiNotaDeb_MotiNC", null).Text("PENALIDADES").HtmlAttributes(new { @class = "colored-success", @value = "3" })
                                </div>
                            </div>
                            <div class="form-group" style="margin:0">
                                <div class="col-md-4">
                                    @Html.Bootstrap().RadioButton("RadiNotaDeb_MotiNC", null).Text("AJUSTES AFECTOS AL IVAP").HtmlAttributes(new { @class = "colored-success", @value = "4" })
                                </div>
                                <div class="col-md-4">
                                    @Html.Bootstrap().RadioButton("RadiNotaDeb_MotiNC", null).Text("AJUSTES DE OPERACIONES DE EXPORTACIÓN").HtmlAttributes(new { @class = "colored-success", @value = "5" })
                                </div>
                            </div>
                        </div>
                        <div class="horizontal-space"></div>
                        <div class="row">
                            <div class="col-md-4" style="text-align:right;vertical-align:middle;width:50%">
                                @Html.Bootstrap().Button().Text("Generar").Color(BootstrapColors.Blue).Shiny().HtmlAttributes(new { @onclick = "FnSaveNewNotaDebito()" })
                            </div>
                            <div class="col-md-2">
                                <button class="btn bg-blue shiny" type="button" id="btnCancel" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>

                    </div>
                </div>
            }
        </div>
    </div>
</div>
<div id="spinnerNotaDebCreate" class="loading">
    <img src="~/img/spinner2.gif" alt="Loading" />
</div>
<script src="~/Scripts/UserFunction.js"></script>
<script type="text/javascript">
    var arrNotaDebDeta = new Array();
    $(document).ready(function () {
        $("#spinnerNotaDebCreate").hide();
        //Inicia();
        $('#spinnerNotaDebCreate').bind("ajaxSend", function () {
            $(this).show();
        }).bind("ajaxComplete", function () {
            $(this).hide();
        });
        $('#loading').hide().ajaxStart(function () {
            $(this).show();
        }).ajaxStop(function () {
            $(this).hide();
        });
    });

    function FnSaveNewNotaDebito() {
        debugger;
        SiglCV = $("#HiddNotaDeb_SiglCV").val();
        var flgAfecStoc = "0";
        var MotiNC = $('input[name=RadiNotaDeb_MotiNC]:checked').val();
        if (typeof MotiNC === "undefined") {
            MotiNC = 0;
        }
        else if (parseInt(MotiNC) == 1 || parseInt(MotiNC) == 2 || parseInt(MotiNC) == 3 || parseInt(MotiNC) == 6 || parseInt(MotiNC) == 7) {
            //flgAfecStoc = 1;
        }
        var FkCompVent = $("#HiddNotaDeb_FkCompVent").val();
        var FechEmisNC = $("#txtNotaDeb_FechEmis").val();
        var NroCompNC = $("#txtNotaDeb_NroComp").val();
        //var TotaNetoNC = parseFloat(document.getElementById("TDCompVentTotaNeto").innerHTML);
        //var TotaIgvNC = parseFloat(document.getElementById("TDCompVentTotaIgv").innerHTML);
        //var TotaBrutNC = parseFloat(document.getElementById("TDCompVentTotaBruto").innerHTML);

        //var CantTrs = document.getElementById("tBodyVentDetalle").rows.length;

        var CantTrs = document.getElementById("tBodyVentDetalle").rows.length;
        var CVTotaNeto = parseFloat(document.getElementById("TDCompVentTotaNeto").innerHTML);
        var CVTotaIgv = parseFloat(document.getElementById("TDCompVentTotaIgv").innerHTML);
        var CVTotaBrut = parseFloat(document.getElementById("TDCompVentTotaBrutoP").innerHTML);
        var CVTotaExonerado = parseFloat(document.getElementById("TDCompVentTotaExo").innerHTML);
        var CVTotaInafecto = parseFloat(document.getElementById("TDCompVentTotaIna").innerHTML);
        var CVTotaGratuito = parseFloat(document.getElementById("TDCompVentTotaGra").innerHTML);

        var CVSaldBrut = 0;


        DescMotiNC = "";
        FnLlenaArrayNotaDebDetalle();
        var flgError = 0;
        if (NroCompNC.trim() == "") {
            sweetAlert("", "Ingrese Nro del Comprobante", "error");
            flgError = 1;
        } else if (FechEmisNC.trim() == "") {
            sweetAlert("", "Ingrese fecha de emisión", "error");
            flgError = 1;
        } else if (MotiNC == 0) {
            sweetAlert("", "SELECCIONE UN MOTIVO DE LA NOTA DE CRÉDITO", "error");
            flgError = 1;
        }
        if (flgError == 0) {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("SaveNewNotaDebito", "NotaDebito")',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    FkCompVent: FkCompVent, NroCompNC: NroCompNC, FechEmisNC: FechEmisNC
                    , DescMotiNC: DescMotiNC, MotiNC: MotiNC, flgAfecStoc: flgAfecStoc, arrNotaDebDeta: arrNotaDebDeta
                    , TotaNetoNC: CVTotaNeto, TotaIgvNC: CVTotaIgv, TotaBrutNC: CVTotaBrut, Sigla: SiglCV
                    , TotalExonerado: CVTotaExonerado, TotalInafecto: CVTotaInafecto, TotalGratuito: CVTotaGratuito
                }),
                dataType: 'json',
                beforeSend: function () {
                    $('#spinnerNotaDebCreate').show();
                },
                traditional: true,
                success: function (data) {
                    console.log("data: ", JSON.stringify(data));
                    if (parseInt(data.IdNewVent) == -1) {
                        sweetAlert("", data.msgRpta, "error");
                    }
                    else {
                        FnPrinterNotaDebitoVenta(data.IdNotaDebVent, data.DataQr);
                        location.reload();
                    }

                },
                error: function (data) {
                    sweetAlert("", data.responseText, "error");
                },
                complete: function () {
                    //check that it does exist and remove
                    if ($('#spinnerNotaDebCreate').length > 0) {
                        $('#spinnerNotaDebCreate').hide();
                    }
                }
            });
        }
    }

    function FnPrinterNotaDebitoVenta(IdNotaDebVent, DataQr) {
        var url = '@Url.Action("PrintNotaDebitoView", "NotaDebito")?IdNotaDebVent=' + IdNotaDebVent +
            '&DataQr=' + DataQr;
        window.open(url, "_blank")
    }

    function FnResetAlmacen() {
        $('#cmbCompVentEdit_FkAlma').get(0).selectedIndex = 0;
        $('#cmbCompVentEdit_FkAlma').prop('disabled', false);
        $('#form-field-checkbox').prop('disabled', false);
        $('#form-field-checkbox').prop('checked', false);
    }

    function FnAgregaInteres() {
        debugger;
        var opcion = $('input[name=RadiNotaDeb_MotiNC]:checked').val();
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var IdTrVD = "IdTrEditVD" + cantRows + 1;

        var TDIdVentDeta = "TDIdVentDeta" + IdTrVD;
        var TDFkProd = "TDFkProd" + IdTrVD;
        var TDCodiProd = "TDCodiProd" + IdTrVD;
        var TDNombProd = "TDNombProd" + IdTrVD;
        var TDCant = "TDCant" + IdTrVD;
        var TDPrec = "TDPrec" + IdTrVD;
        var TDTotaNeto = "TDTotaNeto" + IdTrVD;
        var TDTotaIgv = "TDTotaIgv" + IdTrVD;
        var TDTotaBruto = "TDTotaBruto" + IdTrVD;
        var TDBtnDeleteDeta = "TDBtnDeleteDeta" + IdTrVD;
        var TDFkTipoAfecIgv = "TDFkTipoAfecIgv" + IdTrVD;
        var TDFlgAfecIgv = "TDFlgAfecIgv" + IdTrVD;
        var TDPorcIgv = "TDPorcIgv" + IdTrVD;
        var TDHiddCant = "TDHiddCant" + IdTrVD;
        var TDBtnDescAfec = "TDBtnDescAfec" + IdTrVD;
        var TDHiddTipoBien = "TDHiddTipoBien" + IdTrVD;
        var TDHiddCodSunat = "TDHiddCodSunat" + IdTrVD;
        var TDHiddIsc = "TDHiddIsc" + IdTrVD;
        var TDBtnCTDDelete = "TDBtnCTDDelete" + IdTrVD;

        var strTxtCant = '@Html.Bootstrap().TextBox("txtCant").Size(InputSize.XSmall).HtmlAttributes(new { @onchange = "FnValidaCantidad(this)", @onfocus = "this.oldvalue = this.value;", @type = "number", @min = "0", @style = "text-align: right;border-radius: 6px !important;height: 25px" })';
        var strTxtCodSunat = '@Html.Bootstrap().TextBox("txtCodSunat").Size(InputSize.XSmall).HtmlAttributes(new { @onfocus = "this.oldvalue = this.value;", @type = "text", @style = "text-align: center;border-radius: 6px !important;height: 25px" })';
        var strTxtPrec = '@Html.Bootstrap().TextBox("txtPrec").Size(InputSize.XSmall).HtmlAttributes(new { @onchange = "FnValidaPrecio(this)", @onfocus = "this.oldvalue = this.value;", @type = "number", @min = "0", @style = "text-align: right;border-radius: 6px !important;height: 25px" })';
        var strBtnDeta= '@Html.Bootstrap().Button().Text("").Color(BootstrapColors.Default).HtmlAttributes(new { @class = "danger", @title="Eliminar Detalle", @onclick = "FnDeleteDetalle(this)" }).Shiny().Size(ButtonSize.Mini).IconOnly().IconPrepend(FontAwesome.Times)';


        if (parseInt(opcion) == 1) {
            var row = $("<tr id='" + IdTrVD + "'>" +
                "<td id='" + TDIdVentDeta + "' class='input-xs' style='display: none;'>0</td>" +
                "<td id='" + TDFkProd + "' class='input-xs' style='display: none;'>0</td>" +
                "<td id='" + TDCodiProd + "' class='input-xs' style='text-align: center;'>I00001</td>" +
                "<td id='" + TDNombProd + "' class='input-xs' style='text-align: left;'>INTERES MORATORIO</td>" +
                "<td id='' class='input-xs'>" +
                "<select name='" + TDIgvSelecProd + "' id='" + TDIgvSelecProd + "' style='border-radius:6px !important' onchange='FnSetTaxes(this)'>" +
                "<option value='18|1|IGV'>Gravado Operación Onerosa</option>" +
                "<option value='0|2|GRA'>[Gratuito] Gravado Retiro por premio</option>" +
                "<option value='0|3|GRA'>[Gratuito] Gravado Retiro por donación</option>" +
                "<option value='0|4|GRA'>[Gratuito] Gravado Retiro</option>" +
                "<option value='0|5|GRA'>[Gratuito] Gravado Retiro por publicidad</option>" +
                "<option value='0|6|GRA'>[Gratuito] Gravado Bonificaciones</option>" +
                "<option value='0|7|GRA'>[Gratuito] Gravado Retiro por entrega a trabajadores</option>" +
                "<option value='0|8|EXO'>Exonerado Operación Onerosa</option>" +
                "<option value='0|9|INA'>Inafecto Operación Onerosa</option>" +
                "<option value='0|10|GRA'>[Gratuito] Inafecto Retiro por Bonificación</option>" +
                "<option value='0|11|GRA'>[Gratuito] Inafecto Retiro</option>" +
                "<option value='0|12|GRA'>[Gratuito] Inafecto Retiro por Muestras Médicas</option>" +
                "<option value='0|13|GRA'>[Gratuito] Inafecto Retiro por Convenio Colectivo</option>" +
                "<option value='0|14|GRA'>[Gratuito] Inafecto Retiro por premio</option>" +
                "<option value='0|15|GRA'>[Gratuito] Inafecto Retiro por publicidad</option>" +
                "<option value='0|16|INA'>Exportación</option>" +
                "</select>" +
                "</td>" +
                "<td id='" + TDCant + "' class='input-xs' style='text-align: right;'>" + strTxtCant + "</td>" +
                "<td id='" + TDPrec + "' class='input-xs' style='text-align: right;'>" + strTxtPrec + "</td>" +
                "<td id='" + TDTotaNeto + "' class='input-xs' style='text-align: right;'>" + 0 + "</td>" +
                "<td id='" + TDTotaIgv + "' class='input-xs' style='text-align: right;'>" + 0 + "</td>" +
                "<td id='" + TDTotaBruto + "' class='input-xs' style='text-align: right;'>" + 0 + "</td>" +
                "<td id='" + TDBtnDescAfec + "' class='input-xs' style='text-align: right;display:none;'>Gravado Operación Onerosa</td>" +
                "<td id='" + TDFkTipoAfecIgv + "' class='input-xs' style='text-align: right;display:none'>1</td>" +
                "<td id='" + TDFlgAfecIgv + "' class='input-xs' style='text-align: center;display:none'>1</td>" +
                "<td id='" + TDPorcIgv + "' class='input-xs' style='text-align: center;display:none'>18</td>" +
                "<td id='" + TDHiddTipoBien + "' class='input-xs' style='text-align: center;display:none'>NIU</td>" +
                "<td id='" + TDHiddCodSunat + "' class='input-xs' style='text-align: center;display:none'></td>" +
                "<td id='" + TDHiddIsc + "' class='input-xs' style='text-align: center;display:none'>0</td>" +
                "<td id='" + TDBtnCTDDelete + "' class='input-xs' style='text-align: center;'>" + strBtnDeta + "</td>" +
                "</tr>");
            $("#tBodyVentDetalle").append(row);
        } else {

        }
    }

    function FnLlenaArrayNotaDebDetalle() {
        debugger;
        arrNotaDebDeta = [];
        var IndArr = 0;
        var table = document.getElementById('tBodyVentDetalle');
        var cantRows = table.rows.length;
        var newTr = "";
        var FkVentDeta = "";
        var Cant = "";
        var Prec = "";
        var FkProd = 0;
        var CodProd = "";
        //var ValorVenta = "";
        //var IgvVenta = "";
        //var TipoBien = "";
        //var CodSunat = "";
        //var Codigo = "";
        //var NombProd = "";
        //var FlgAfecIgv = "";
        //var HiddIsc = "";
        //var TotBruto = "";

        var Neto = "";
        var Igv = "";
        var Importe = "";
        var FkTipoAfecIGV = 0;
        var StrDisp = "";
        var PorRegu = "";
        var CodSunat = "";
        var DescripPro = "";
        var TipoBienItem = "";

        if (cantRows > 0) {
            for (var i = 0; i < cantRows; i++) {
                newTr = table.rows[i].id;
                if (newTr.trim() != "") {
                    CodSunat = document.getElementById("TDHiddCodSunat" + newTr).innerHTML;
                    FkVentDeta = document.getElementById("TDIdVentDeta" + newTr).innerHTML;
                    DescripPro = document.getElementById("TDNombProd" + newTr).innerHTML;
                    var objTxt = document.getElementById("TDCant" + newTr).children;
                    Cant = objTxt[0].value;
                    objTxt = document.getElementById("TDPrec" + newTr).children;
                    Prec = objTxt[0].value;
                    FkProd = document.getElementById("TDFkProd" + newTr).innerHTML;
                    CodProd = document.getElementById("TDCodiProd" + newTr).innerHTML;
                    FkTipoAfecIGV = document.getElementById("TDFkTipoAfecIgv" + newTr).innerHTML;
                    Neto = document.getElementById("TDTotaNeto" + newTr).innerHTML;
                    Igv = document.getElementById("TDTotaIgv" + newTr).innerHTML;
                    Importe = document.getElementById("TDTotaBruto" + newTr).innerHTML;
                    TipoBienItem = document.getElementById("TDHiddTipoBien" + newTr).innerHTML;

                    //TipoBien = document.getElementById("TDHiddTipoBien" + newTr).innerHTML;
                    //Codigo = document.getElementById("TDCodigo" + newTr).innerHTML;
                    //ValorVenta = document.getElementById("TDTotaNeto" + newTr).innerHTML;
                    //IgvVenta = document.getElementById("TDTotaIgv" + newTr).innerHTML;
                    //NombProd = document.getElementById("TDNombProd" + newTr).innerHTML;
                    //FlgAfecIgv = document.getElementById("TDFlgAfecIgv" + newTr).innerHTML;
                    //HiddIsc = document.getElementById("TDHiddIsc" + newTr).innerHTML;
                    
                    
                    //TotBruto = document.getElementById("TDTotaBruto" + newTr).innerHTML;



                    //arrNotaDebDeta[IndArr] = new Array(12);
                    //arrNotaDebDeta[IndArr][0] = FkVentDeta.trim();
                    //arrNotaDebDeta[IndArr][1] = Cant.trim();
                    //arrNotaDebDeta[IndArr][2] = Prec.trim();
                    //arrNotaDebDeta[IndArr][3] = FkProd.trim();
                    //arrNotaDebDeta[IndArr][4] = TipoBien.trim();
                    //arrNotaDebDeta[IndArr][5] = CodSunat.trim();
                    //arrNotaDebDeta[IndArr][6] = FkProd.trim();
                    //arrNotaDebDeta[IndArr][7] = ValorVenta.trim();
                    //arrNotaDebDeta[IndArr][8] = IgvVenta.trim();
                    //arrNotaDebDeta[IndArr][9] = Codigo.trim();
                    //arrNotaDebDeta[IndArr][10] = NombProd.trim();
                    //arrNotaDebDeta[IndArr][11] = FlgAfecIgv.trim();
                    //arrNotaDebDeta[IndArr][12] = HiddIsc.trim();
                    //arrNotaDebDeta[IndArr][13] = TotBruto.trim();
                    //IndArr++;

                    arrNotaDebDeta[IndArr] = new Array(12);
                    arrNotaDebDeta[IndArr][0] = FkVentDeta.trim();
                    arrNotaDebDeta[IndArr][1] = Cant.trim();
                    arrNotaDebDeta[IndArr][2] = Prec.trim();
                    arrNotaDebDeta[IndArr][3] = FkProd.trim();
                    arrNotaDebDeta[IndArr][4] = FkTipoAfecIGV.trim();
                    arrNotaDebDeta[IndArr][5] = CodSunat.trim();
                    arrNotaDebDeta[IndArr][6] = CodProd.trim();
                    arrNotaDebDeta[IndArr][7] = DescripPro.trim();
                    arrNotaDebDeta[IndArr][8] = Neto.trim();
                    arrNotaDebDeta[IndArr][9] = Igv.trim();
                    arrNotaDebDeta[IndArr][10] = Importe.trim();
                    arrNotaDebDeta[IndArr][11] = TipoBienItem.trim();
                    IndArr++;


                }
            }
        }
    }
</script>
<style type="text/css">
    .modal-backdrop {
        z-index: -1;
    }

    .cssTrSinStock {
        background-color: rgba(244,157,138,0.8) !important;
    }
</style>